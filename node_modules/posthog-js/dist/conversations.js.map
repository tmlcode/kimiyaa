{"version":3,"file":"conversations.js","sources":["../../../node_modules/.pnpm/preact@10.19.3/node_modules/preact/dist/preact.module.js","../../core/dist/utils/type-utils.mjs","../src/utils/globals.ts","../src/utils/logger.ts","../src/uuidv7.ts","../src/extensions/conversations/external/persistence.ts","../src/extensions/conversations/external/components/styles.ts","../src/extensions/conversations/external/components/OpenChatButton.tsx","../src/extensions/conversations/external/components/SendMessageButton.tsx","../src/extensions/conversations/external/components/CloseChatButton.tsx","../src/extensions/conversations/external/components/ConversationsWidget.tsx","../src/utils/index.ts","../src/utils/request-utils.ts","../src/extensions/conversations/external/index.tsx","../src/entrypoints/conversations.ts"],"sourcesContent":["var n,l,u,t,i,o,r,f,e,c={},s=[],a=/acit|ex(?:s|g|n|p|$)|rph|grid|ows|mnc|ntw|ine[ch]|zoo|^ord|itera/i,h=Array.isArray;function v(n,l){for(var u in l)n[u]=l[u];return n}function p(n){var l=n.parentNode;l&&l.removeChild(n)}function y(l,u,t){var i,o,r,f={};for(r in u)\"key\"==r?i=u[r]:\"ref\"==r?o=u[r]:f[r]=u[r];if(arguments.length>2&&(f.children=arguments.length>3?n.call(arguments,2):t),\"function\"==typeof l&&null!=l.defaultProps)for(r in l.defaultProps)void 0===f[r]&&(f[r]=l.defaultProps[r]);return d(l,f,i,o,null)}function d(n,t,i,o,r){var f={type:n,props:t,key:i,ref:o,__k:null,__:null,__b:0,__e:null,__d:void 0,__c:null,constructor:void 0,__v:null==r?++u:r,__i:-1,__u:0};return null==r&&null!=l.vnode&&l.vnode(f),f}function _(){return{current:null}}function g(n){return n.children}function b(n,l){this.props=n,this.context=l}function m(n,l){if(null==l)return n.__?m(n.__,n.__i+1):null;for(var u;l<n.__k.length;l++)if(null!=(u=n.__k[l])&&null!=u.__e)return u.__e;return\"function\"==typeof n.type?m(n):null}function k(n){var l,u;if(null!=(n=n.__)&&null!=n.__c){for(n.__e=n.__c.base=null,l=0;l<n.__k.length;l++)if(null!=(u=n.__k[l])&&null!=u.__e){n.__e=n.__c.base=u.__e;break}return k(n)}}function w(n){(!n.__d&&(n.__d=!0)&&i.push(n)&&!x.__r++||o!==l.debounceRendering)&&((o=l.debounceRendering)||r)(x)}function x(){var n,u,t,o,r,e,c,s,a;for(i.sort(f);n=i.shift();)n.__d&&(u=i.length,o=void 0,e=(r=(t=n).__v).__e,s=[],a=[],(c=t.__P)&&((o=v({},r)).__v=r.__v+1,l.vnode&&l.vnode(o),L(c,o,r,t.__n,void 0!==c.ownerSVGElement,32&r.__u?[e]:null,s,null==e?m(r):e,!!(32&r.__u),a),o.__.__k[o.__i]=o,M(s,o,a),o.__e!=e&&k(o)),i.length>u&&i.sort(f));x.__r=0}function C(n,l,u,t,i,o,r,f,e,a,h){var v,p,y,d,_,g=t&&t.__k||s,b=l.length;for(u.__d=e,P(u,l,g),e=u.__d,v=0;v<b;v++)null!=(y=u.__k[v])&&\"boolean\"!=typeof y&&\"function\"!=typeof y&&(p=-1===y.__i?c:g[y.__i]||c,y.__i=v,L(n,y,p,i,o,r,f,e,a,h),d=y.__e,y.ref&&p.ref!=y.ref&&(p.ref&&z(p.ref,null,y),h.push(y.ref,y.__c||d,y)),null==_&&null!=d&&(_=d),65536&y.__u||p.__k===y.__k?e=S(y,e,n):\"function\"==typeof y.type&&void 0!==y.__d?e=y.__d:d&&(e=d.nextSibling),y.__d=void 0,y.__u&=-196609);u.__d=e,u.__e=_}function P(n,l,u){var t,i,o,r,f,e=l.length,c=u.length,s=c,a=0;for(n.__k=[],t=0;t<e;t++)null!=(i=n.__k[t]=null==(i=l[t])||\"boolean\"==typeof i||\"function\"==typeof i?null:\"string\"==typeof i||\"number\"==typeof i||\"bigint\"==typeof i||i.constructor==String?d(null,i,null,null,i):h(i)?d(g,{children:i},null,null,null):void 0===i.constructor&&i.__b>0?d(i.type,i.props,i.key,i.ref?i.ref:null,i.__v):i)?(i.__=n,i.__b=n.__b+1,f=H(i,u,r=t+a,s),i.__i=f,o=null,-1!==f&&(s--,(o=u[f])&&(o.__u|=131072)),null==o||null===o.__v?(-1==f&&a--,\"function\"!=typeof i.type&&(i.__u|=65536)):f!==r&&(f===r+1?a++:f>r?s>e-r?a+=f-r:a--:a=f<r&&f==r-1?f-r:0,f!==t+a&&(i.__u|=65536))):(o=u[t])&&null==o.key&&o.__e&&(o.__e==n.__d&&(n.__d=m(o)),N(o,o,!1),u[t]=null,s--);if(s)for(t=0;t<c;t++)null!=(o=u[t])&&0==(131072&o.__u)&&(o.__e==n.__d&&(n.__d=m(o)),N(o,o))}function S(n,l,u){var t,i;if(\"function\"==typeof n.type){for(t=n.__k,i=0;t&&i<t.length;i++)t[i]&&(t[i].__=n,l=S(t[i],l,u));return l}return n.__e!=l&&(u.insertBefore(n.__e,l||null),l=n.__e),l&&l.nextSibling}function $(n,l){return l=l||[],null==n||\"boolean\"==typeof n||(h(n)?n.some(function(n){$(n,l)}):l.push(n)),l}function H(n,l,u,t){var i=n.key,o=n.type,r=u-1,f=u+1,e=l[u];if(null===e||e&&i==e.key&&o===e.type)return u;if(t>(null!=e&&0==(131072&e.__u)?1:0))for(;r>=0||f<l.length;){if(r>=0){if((e=l[r])&&0==(131072&e.__u)&&i==e.key&&o===e.type)return r;r--}if(f<l.length){if((e=l[f])&&0==(131072&e.__u)&&i==e.key&&o===e.type)return f;f++}}return-1}function I(n,l,u){\"-\"===l[0]?n.setProperty(l,null==u?\"\":u):n[l]=null==u?\"\":\"number\"!=typeof u||a.test(l)?u:u+\"px\"}function T(n,l,u,t,i){var o;n:if(\"style\"===l)if(\"string\"==typeof u)n.style.cssText=u;else{if(\"string\"==typeof t&&(n.style.cssText=t=\"\"),t)for(l in t)u&&l in u||I(n.style,l,\"\");if(u)for(l in u)t&&u[l]===t[l]||I(n.style,l,u[l])}else if(\"o\"===l[0]&&\"n\"===l[1])o=l!==(l=l.replace(/(PointerCapture)$|Capture$/,\"$1\")),l=l.toLowerCase()in n?l.toLowerCase().slice(2):l.slice(2),n.l||(n.l={}),n.l[l+o]=u,u?t?u.u=t.u:(u.u=Date.now(),n.addEventListener(l,o?D:A,o)):n.removeEventListener(l,o?D:A,o);else{if(i)l=l.replace(/xlink(H|:h)/,\"h\").replace(/sName$/,\"s\");else if(\"width\"!==l&&\"height\"!==l&&\"href\"!==l&&\"list\"!==l&&\"form\"!==l&&\"tabIndex\"!==l&&\"download\"!==l&&\"rowSpan\"!==l&&\"colSpan\"!==l&&\"role\"!==l&&l in n)try{n[l]=null==u?\"\":u;break n}catch(n){}\"function\"==typeof u||(null==u||!1===u&&\"-\"!==l[4]?n.removeAttribute(l):n.setAttribute(l,u))}}function A(n){var u=this.l[n.type+!1];if(n.t){if(n.t<=u.u)return}else n.t=Date.now();return u(l.event?l.event(n):n)}function D(n){return this.l[n.type+!0](l.event?l.event(n):n)}function L(n,u,t,i,o,r,f,e,c,s){var a,p,y,d,_,m,k,w,x,P,S,$,H,I,T,A=u.type;if(void 0!==u.constructor)return null;128&t.__u&&(c=!!(32&t.__u),r=[e=u.__e=t.__e]),(a=l.__b)&&a(u);n:if(\"function\"==typeof A)try{if(w=u.props,x=(a=A.contextType)&&i[a.__c],P=a?x?x.props.value:a.__:i,t.__c?k=(p=u.__c=t.__c).__=p.__E:(\"prototype\"in A&&A.prototype.render?u.__c=p=new A(w,P):(u.__c=p=new b(w,P),p.constructor=A,p.render=O),x&&x.sub(p),p.props=w,p.state||(p.state={}),p.context=P,p.__n=i,y=p.__d=!0,p.__h=[],p._sb=[]),null==p.__s&&(p.__s=p.state),null!=A.getDerivedStateFromProps&&(p.__s==p.state&&(p.__s=v({},p.__s)),v(p.__s,A.getDerivedStateFromProps(w,p.__s))),d=p.props,_=p.state,p.__v=u,y)null==A.getDerivedStateFromProps&&null!=p.componentWillMount&&p.componentWillMount(),null!=p.componentDidMount&&p.__h.push(p.componentDidMount);else{if(null==A.getDerivedStateFromProps&&w!==d&&null!=p.componentWillReceiveProps&&p.componentWillReceiveProps(w,P),!p.__e&&(null!=p.shouldComponentUpdate&&!1===p.shouldComponentUpdate(w,p.__s,P)||u.__v===t.__v)){for(u.__v!==t.__v&&(p.props=w,p.state=p.__s,p.__d=!1),u.__e=t.__e,u.__k=t.__k,u.__k.forEach(function(n){n&&(n.__=u)}),S=0;S<p._sb.length;S++)p.__h.push(p._sb[S]);p._sb=[],p.__h.length&&f.push(p);break n}null!=p.componentWillUpdate&&p.componentWillUpdate(w,p.__s,P),null!=p.componentDidUpdate&&p.__h.push(function(){p.componentDidUpdate(d,_,m)})}if(p.context=P,p.props=w,p.__P=n,p.__e=!1,$=l.__r,H=0,\"prototype\"in A&&A.prototype.render){for(p.state=p.__s,p.__d=!1,$&&$(u),a=p.render(p.props,p.state,p.context),I=0;I<p._sb.length;I++)p.__h.push(p._sb[I]);p._sb=[]}else do{p.__d=!1,$&&$(u),a=p.render(p.props,p.state,p.context),p.state=p.__s}while(p.__d&&++H<25);p.state=p.__s,null!=p.getChildContext&&(i=v(v({},i),p.getChildContext())),y||null==p.getSnapshotBeforeUpdate||(m=p.getSnapshotBeforeUpdate(d,_)),C(n,h(T=null!=a&&a.type===g&&null==a.key?a.props.children:a)?T:[T],u,t,i,o,r,f,e,c,s),p.base=u.__e,u.__u&=-161,p.__h.length&&f.push(p),k&&(p.__E=p.__=null)}catch(n){u.__v=null,c||null!=r?(u.__e=e,u.__u|=c?160:32,r[r.indexOf(e)]=null):(u.__e=t.__e,u.__k=t.__k),l.__e(n,u,t)}else null==r&&u.__v===t.__v?(u.__k=t.__k,u.__e=t.__e):u.__e=j(t.__e,u,t,i,o,r,f,c,s);(a=l.diffed)&&a(u)}function M(n,u,t){u.__d=void 0;for(var i=0;i<t.length;i++)z(t[i],t[++i],t[++i]);l.__c&&l.__c(u,n),n.some(function(u){try{n=u.__h,u.__h=[],n.some(function(n){n.call(u)})}catch(n){l.__e(n,u.__v)}})}function j(l,u,t,i,o,r,f,e,s){var a,v,y,d,_,g,b,k=t.props,w=u.props,x=u.type;if(\"svg\"===x&&(o=!0),null!=r)for(a=0;a<r.length;a++)if((_=r[a])&&\"setAttribute\"in _==!!x&&(x?_.localName===x:3===_.nodeType)){l=_,r[a]=null;break}if(null==l){if(null===x)return document.createTextNode(w);l=o?document.createElementNS(\"http://www.w3.org/2000/svg\",x):document.createElement(x,w.is&&w),r=null,e=!1}if(null===x)k===w||e&&l.data===w||(l.data=w);else{if(r=r&&n.call(l.childNodes),k=t.props||c,!e&&null!=r)for(k={},a=0;a<l.attributes.length;a++)k[(_=l.attributes[a]).name]=_.value;for(a in k)_=k[a],\"children\"==a||(\"dangerouslySetInnerHTML\"==a?y=_:\"key\"===a||a in w||T(l,a,null,_,o));for(a in w)_=w[a],\"children\"==a?d=_:\"dangerouslySetInnerHTML\"==a?v=_:\"value\"==a?g=_:\"checked\"==a?b=_:\"key\"===a||e&&\"function\"!=typeof _||k[a]===_||T(l,a,_,k[a],o);if(v)e||y&&(v.__html===y.__html||v.__html===l.innerHTML)||(l.innerHTML=v.__html),u.__k=[];else if(y&&(l.innerHTML=\"\"),C(l,h(d)?d:[d],u,t,i,o&&\"foreignObject\"!==x,r,f,r?r[0]:t.__k&&m(t,0),e,s),null!=r)for(a=r.length;a--;)null!=r[a]&&p(r[a]);e||(a=\"value\",void 0!==g&&(g!==l[a]||\"progress\"===x&&!g||\"option\"===x&&g!==k[a])&&T(l,a,g,k[a],!1),a=\"checked\",void 0!==b&&b!==l[a]&&T(l,a,b,k[a],!1))}return l}function z(n,u,t){try{\"function\"==typeof n?n(u):n.current=u}catch(n){l.__e(n,t)}}function N(n,u,t){var i,o;if(l.unmount&&l.unmount(n),(i=n.ref)&&(i.current&&i.current!==n.__e||z(i,null,u)),null!=(i=n.__c)){if(i.componentWillUnmount)try{i.componentWillUnmount()}catch(n){l.__e(n,u)}i.base=i.__P=null,n.__c=void 0}if(i=n.__k)for(o=0;o<i.length;o++)i[o]&&N(i[o],u,t||\"function\"!=typeof n.type);t||null==n.__e||p(n.__e),n.__=n.__e=n.__d=void 0}function O(n,l,u){return this.constructor(n,u)}function q(u,t,i){var o,r,f,e;l.__&&l.__(u,t),r=(o=\"function\"==typeof i)?null:i&&i.__k||t.__k,f=[],e=[],L(t,u=(!o&&i||t).__k=y(g,null,[u]),r||c,c,void 0!==t.ownerSVGElement,!o&&i?[i]:r?null:t.firstChild?n.call(t.childNodes):null,f,!o&&i?i:r?r.__e:t.firstChild,o,e),M(f,u,e)}function B(n,l){q(n,l,B)}function E(l,u,t){var i,o,r,f,e=v({},l.props);for(r in l.type&&l.type.defaultProps&&(f=l.type.defaultProps),u)\"key\"==r?i=u[r]:\"ref\"==r?o=u[r]:e[r]=void 0===u[r]&&void 0!==f?f[r]:u[r];return arguments.length>2&&(e.children=arguments.length>3?n.call(arguments,2):t),d(l.type,e,i||l.key,o||l.ref,null)}function F(n,l){var u={__c:l=\"__cC\"+e++,__:n,Consumer:function(n,l){return n.children(l)},Provider:function(n){var u,t;return this.getChildContext||(u=[],(t={})[l]=this,this.getChildContext=function(){return t},this.shouldComponentUpdate=function(n){this.props.value!==n.value&&u.some(function(n){n.__e=!0,w(n)})},this.sub=function(n){u.push(n);var l=n.componentWillUnmount;n.componentWillUnmount=function(){u.splice(u.indexOf(n),1),l&&l.call(n)}}),n.children}};return u.Provider.__=u.Consumer.contextType=u}n=s.slice,l={__e:function(n,l,u,t){for(var i,o,r;l=l.__;)if((i=l.__c)&&!i.__)try{if((o=i.constructor)&&null!=o.getDerivedStateFromError&&(i.setState(o.getDerivedStateFromError(n)),r=i.__d),null!=i.componentDidCatch&&(i.componentDidCatch(n,t||{}),r=i.__d),r)return i.__E=i}catch(l){n=l}throw n}},u=0,t=function(n){return null!=n&&null==n.constructor},b.prototype.setState=function(n,l){var u;u=null!=this.__s&&this.__s!==this.state?this.__s:this.__s=v({},this.state),\"function\"==typeof n&&(n=n(v({},u),this.props)),n&&v(u,n),null!=n&&this.__v&&(l&&this._sb.push(l),w(this))},b.prototype.forceUpdate=function(n){this.__v&&(this.__e=!0,n&&this.__h.push(n),w(this))},b.prototype.render=g,i=[],r=\"function\"==typeof Promise?Promise.prototype.then.bind(Promise.resolve()):setTimeout,f=function(n,l){return n.__v.__b-l.__v.__b},x.__r=0,e=0;export{b as Component,g as Fragment,E as cloneElement,F as createContext,y as createElement,_ as createRef,y as h,B as hydrate,t as isValidElement,l as options,q as render,$ as toChildArray};\n//# sourceMappingURL=preact.module.js.map\n","import { knownUnsafeEditableEvent } from \"../types.mjs\";\nimport { includes } from \"./string-utils.mjs\";\nconst nativeIsArray = Array.isArray;\nconst ObjProto = Object.prototype;\nconst type_utils_hasOwnProperty = ObjProto.hasOwnProperty;\nconst type_utils_toString = ObjProto.toString;\nconst isArray = nativeIsArray || function(obj) {\n    return '[object Array]' === type_utils_toString.call(obj);\n};\nconst isFunction = (x)=>'function' == typeof x;\nconst isNativeFunction = (x)=>isFunction(x) && -1 !== x.toString().indexOf('[native code]');\nconst isObject = (x)=>x === Object(x) && !isArray(x);\nconst isEmptyObject = (x)=>{\n    if (isObject(x)) {\n        for(const key in x)if (type_utils_hasOwnProperty.call(x, key)) return false;\n        return true;\n    }\n    return false;\n};\nconst isUndefined = (x)=>void 0 === x;\nconst isString = (x)=>'[object String]' == type_utils_toString.call(x);\nconst isEmptyString = (x)=>isString(x) && 0 === x.trim().length;\nconst isNull = (x)=>null === x;\nconst isNullish = (x)=>isUndefined(x) || isNull(x);\nconst isNumber = (x)=>'[object Number]' == type_utils_toString.call(x);\nconst isBoolean = (x)=>'[object Boolean]' === type_utils_toString.call(x);\nconst isFormData = (x)=>x instanceof FormData;\nconst isFile = (x)=>x instanceof File;\nconst isPlainError = (x)=>x instanceof Error;\nconst isKnownUnsafeEditableEvent = (x)=>includes(knownUnsafeEditableEvent, x);\nfunction isInstanceOf(candidate, base) {\n    try {\n        return candidate instanceof base;\n    } catch  {\n        return false;\n    }\n}\nfunction isPrimitive(value) {\n    return null === value || 'object' != typeof value;\n}\nfunction isBuiltin(candidate, className) {\n    return Object.prototype.toString.call(candidate) === `[object ${className}]`;\n}\nfunction isError(candidate) {\n    switch(Object.prototype.toString.call(candidate)){\n        case '[object Error]':\n        case '[object Exception]':\n        case '[object DOMException]':\n        case '[object DOMError]':\n        case '[object WebAssembly.Exception]':\n            return true;\n        default:\n            return isInstanceOf(candidate, Error);\n    }\n}\nfunction isErrorEvent(event) {\n    return isBuiltin(event, 'ErrorEvent');\n}\nfunction isEvent(candidate) {\n    return !isUndefined(Event) && isInstanceOf(candidate, Event);\n}\nfunction isPlainObject(candidate) {\n    return isBuiltin(candidate, 'Object');\n}\nconst yesLikeValues = [\n    true,\n    'true',\n    1,\n    '1',\n    'yes'\n];\nconst isYesLike = (val)=>includes(yesLikeValues, val);\nconst noLikeValues = [\n    false,\n    'false',\n    0,\n    '0',\n    'no'\n];\nconst isNoLike = (val)=>includes(noLikeValues, val);\nexport { type_utils_hasOwnProperty as hasOwnProperty, isArray, isBoolean, isBuiltin, isEmptyObject, isEmptyString, isError, isErrorEvent, isEvent, isFile, isFormData, isFunction, isInstanceOf, isKnownUnsafeEditableEvent, isNativeFunction, isNoLike, isNull, isNullish, isNumber, isObject, isPlainError, isPlainObject, isPrimitive, isString, isUndefined, isYesLike, noLikeValues, yesLikeValues };\n","import type { PostHog } from '../posthog-core'\nimport { SessionIdManager } from '../sessionid'\nimport {\n    DeadClicksAutoCaptureConfig,\n    ExternalIntegrationKind,\n    Properties,\n    RemoteConfig,\n    SiteAppLoader,\n    SessionStartReason,\n} from '../types'\nimport type { ConversationsRemoteConfig } from '../posthog-conversations-types'\n// only importing types here, so won't affect the bundle\n// eslint-disable-next-line posthog-js/no-external-replay-imports\nimport type { SessionRecordingStatus, TriggerType } from '../extensions/replay/external/triggerMatching'\nimport { eventWithTime } from '../extensions/replay/types/rrweb-types'\nimport { ErrorTracking } from '@posthog/core'\n\n/*\n * Global helpers to protect access to browser globals in a way that is safer for different targets\n * like DOM, SSR, Web workers etc.\n *\n * NOTE: Typically we want the \"window\" but globalThis works for both the typical browser context as\n * well as other contexts such as the web worker context. Window is still exported for any bits that explicitly require it.\n * If in doubt - export the global you need from this file and use that as an optional value. This way the code path is forced\n * to handle the case where the global is not available.\n */\n\n// eslint-disable-next-line no-restricted-globals\nconst win: (Window & typeof globalThis) | undefined = typeof window !== 'undefined' ? window : undefined\n\nexport type AssignableWindow = Window &\n    typeof globalThis & {\n        /*\n         * Main PostHog instance\n         */\n        posthog: any\n\n        /*\n         * This is our contract between (potentially) lazily loaded extensions and the SDK\n         */\n        __PosthogExtensions__?: PostHogExtensions\n\n        /**\n         * When loading remote config, we assign it to this global configuration\n         * for ease of sharing it with the rest of the SDK\n         */\n        _POSTHOG_REMOTE_CONFIG?: Record<\n            string,\n            {\n                config: RemoteConfig\n                siteApps: SiteAppLoader[]\n            }\n        >\n\n        /**\n         * If this is set on the window, our logger will log to the console\n         * for ease of debugging. Used for testing purposes only.\n         *\n         * @see {Config.DEBUG} from config.ts\n         */\n        POSTHOG_DEBUG: any\n\n        // Exposed by the browser\n        doNotTrack: any\n\n        // See entrypoints/customizations.full.ts\n        posthogCustomizations: any\n\n        /**\n         * This is a legacy way to expose these functions, but we still need to support it for backwards compatibility\n         * Can be removed once we drop support for 1.161.1\n         *\n         * See entrypoints/exception-autocapture.ts\n         *\n         * @deprecated use `__PosthogExtensions__.errorWrappingFunctions` instead\n         */\n        posthogErrorWrappingFunctions: any\n\n        /**\n         * This is a legacy way to expose these functions, but we still need to support it for backwards compatibility\n         * Can be removed once we drop support for 1.161.1\n         *\n         * See entrypoints/posthog-recorder.ts\n         *\n         * @deprecated use `__PosthogExtensions__.rrweb` instead\n         */\n        rrweb: any\n\n        /**\n         * This is a legacy way to expose these functions, but we still need to support it for backwards compatibility\n         * Can be removed once we drop support for 1.161.1\n         *\n         * See entrypoints/posthog-recorder.ts\n         *\n         * @deprecated use `__PosthogExtensions__.rrwebConsoleRecord` instead\n         */\n        rrwebConsoleRecord: any\n\n        /**\n         * This is a legacy way to expose these functions, but we still need to support it for backwards compatibility\n         * Can be removed once we drop support for 1.161.1\n         *\n         * See entrypoints/posthog-recorder.ts\n         *\n         * @deprecated use `__PosthogExtensions__.getRecordNetworkPlugin` instead\n         */\n        getRecordNetworkPlugin: any\n\n        /**\n         * This is a legacy way to expose these functions, but we still need to support it for backwards compatibility\n         * Can be removed once we drop support for 1.161.1\n         *\n         * See entrypoints/web-vitals.ts\n         *\n         * @deprecated use `__PosthogExtensions__.postHogWebVitalsCallbacks` instead\n         */\n        postHogWebVitalsCallbacks: any\n\n        /**\n         * This is a legacy way to expose these functions, but we still need to support it for backwards compatibility\n         * Can be removed once we drop support for 1.161.1\n         *\n         * See entrypoints/tracing-headers.ts\n         *\n         * @deprecated use `__PosthogExtensions__.postHogTracingHeadersPatchFns` instead\n         */\n        postHogTracingHeadersPatchFns: any\n\n        /**\n         * This is a legacy way to expose these functions, but we still need to support it for backwards compatibility\n         * Can be removed once we drop support for 1.161.1\n         *\n         * See entrypoints/surveys.ts\n         *\n         * @deprecated use `__PosthogExtensions__.generateSurveys` instead\n         */\n        extendPostHogWithSurveys: any\n\n        /*\n         * These are used to handle our toolbar state.\n         * @see {Toolbar} from extensions/toolbar.ts\n         */\n        ph_load_toolbar: any\n        ph_load_editor: any\n        ph_toolbar_state: any\n    } & Record<`__$$ph_site_app_${string}`, any>\n\n/**\n * This is our contract between (potentially) lazily loaded extensions and the SDK\n * changes to this interface can be breaking changes for users of the SDK\n */\n\nexport type ExternalExtensionKind = 'intercom-integration' | 'crisp-chat-integration'\n\nexport type PostHogExtensionKind =\n    | 'toolbar'\n    | 'exception-autocapture'\n    | 'web-vitals'\n    | 'recorder'\n    | 'lazy-recorder'\n    | 'tracing-headers'\n    | 'surveys'\n    | 'conversations'\n    | 'product-tours'\n    | 'dead-clicks-autocapture'\n    | 'remote-config'\n    | ExternalExtensionKind\n\nexport interface LazyLoadedSessionRecordingInterface {\n    start: (startReason?: SessionStartReason) => void\n    stop: () => void\n    sessionId: string\n    status: SessionRecordingStatus\n    onRRwebEmit: (rawEvent: eventWithTime) => void\n    log: (message: string, level: 'log' | 'warn' | 'error') => void\n    sdkDebugProperties: Properties\n    overrideLinkedFlag: () => void\n    overrideSampling: () => void\n    overrideTrigger: (triggerType: TriggerType) => void\n    isStarted: boolean\n    tryAddCustomEvent(tag: string, payload: any): boolean\n}\n\nexport interface LazyLoadedDeadClicksAutocaptureInterface {\n    start: (observerTarget: Node) => void\n    stop: () => void\n}\n\nexport interface LazyLoadedConversationsInterface {\n    enable: () => void\n    disable: () => void\n    destroy: () => void\n    reset: () => void\n}\n\ninterface PostHogExtensions {\n    loadExternalDependency?: (\n        posthog: PostHog,\n        kind: PostHogExtensionKind,\n        callback: (error?: string | Event, event?: Event) => void\n    ) => void\n\n    loadSiteApp?: (posthog: PostHog, appUrl: string, callback: (error?: string | Event, event?: Event) => void) => void\n\n    errorWrappingFunctions?: {\n        wrapOnError: (captureFn: (props: ErrorTracking.ErrorProperties) => void) => () => void\n        wrapUnhandledRejection: (captureFn: (props: ErrorTracking.ErrorProperties) => void) => () => void\n        wrapConsoleError: (captureFn: (props: ErrorTracking.ErrorProperties) => void) => () => void\n    }\n    rrweb?: { record: any; version: string }\n    rrwebPlugins?: { getRecordConsolePlugin: any; getRecordNetworkPlugin?: any }\n    generateSurveys?: (posthog: PostHog, isSurveysEnabled: boolean) => any | undefined\n    generateProductTours?: (posthog: PostHog, isEnabled: boolean) => any | undefined\n    postHogWebVitalsCallbacks?: {\n        onLCP: (metric: any) => void\n        onCLS: (metric: any) => void\n        onFCP: (metric: any) => void\n        onINP: (metric: any) => void\n    }\n    tracingHeadersPatchFns?: {\n        _patchFetch: (hostnames: string[], distinctId: string, sessionManager?: SessionIdManager) => () => void\n        _patchXHR: (hostnames: string[], distinctId: string, sessionManager?: SessionIdManager) => () => void\n    }\n    initDeadClicksAutocapture?: (\n        ph: PostHog,\n        config: DeadClicksAutoCaptureConfig\n    ) => LazyLoadedDeadClicksAutocaptureInterface\n    integrations?: {\n        [K in ExternalIntegrationKind]?: { start: (posthog: PostHog) => void; stop: () => void }\n    }\n    initSessionRecording?: (ph: PostHog) => LazyLoadedSessionRecordingInterface\n    initConversations?: (config: ConversationsRemoteConfig, posthog: PostHog) => LazyLoadedConversationsInterface\n}\n\nconst global: typeof globalThis | undefined = typeof globalThis !== 'undefined' ? globalThis : win\n\n// React Native polyfills for posthog-js compatibility\nif (typeof self === 'undefined') {\n    ;(global as any).self = global\n}\nif (typeof File === 'undefined') {\n    ;(global as any).File = function () {}\n}\n\nexport const ArrayProto = Array.prototype\nexport const nativeForEach = ArrayProto.forEach\nexport const nativeIndexOf = ArrayProto.indexOf\n\nexport const navigator = global?.navigator\nexport const document = global?.document\nexport const location = global?.location\nexport const fetch = global?.fetch\nexport const XMLHttpRequest =\n    global?.XMLHttpRequest && 'withCredentials' in new global.XMLHttpRequest() ? global.XMLHttpRequest : undefined\nexport const AbortController = global?.AbortController\nexport const userAgent = navigator?.userAgent\nexport const assignableWindow: AssignableWindow = win ?? ({} as any)\n\nexport { win as window }\n","import Config from '../config'\nimport { isUndefined } from '@posthog/core'\nimport { assignableWindow, window } from './globals'\nimport type { Logger } from '@posthog/core'\n\ntype CreateLoggerOptions = {\n    debugEnabled?: boolean\n}\n\ntype PosthogJsLogger = Omit<Logger, 'createLogger'> & {\n    _log: (level: 'log' | 'warn' | 'error', ...args: any[]) => void\n    uninitializedWarning: (methodName: string) => void\n    createLogger: (prefix: string, options?: CreateLoggerOptions) => PosthogJsLogger\n}\n\nconst _createLogger = (prefix: string, { debugEnabled }: CreateLoggerOptions = {}): PosthogJsLogger => {\n    const logger: PosthogJsLogger = {\n        _log: (level: 'log' | 'warn' | 'error', ...args: any[]) => {\n            if (\n                window &&\n                (Config.DEBUG || assignableWindow.POSTHOG_DEBUG || debugEnabled) &&\n                !isUndefined(window.console) &&\n                window.console\n            ) {\n                const consoleLog =\n                    '__rrweb_original__' in window.console[level]\n                        ? (window.console[level] as any)['__rrweb_original__']\n                        : window.console[level]\n\n                // eslint-disable-next-line no-console\n                consoleLog(prefix, ...args)\n            }\n        },\n\n        info: (...args: any[]) => {\n            logger._log('log', ...args)\n        },\n\n        warn: (...args: any[]) => {\n            logger._log('warn', ...args)\n        },\n\n        error: (...args: any[]) => {\n            logger._log('error', ...args)\n        },\n\n        critical: (...args: any[]) => {\n            // Critical errors are always logged to the console\n            // eslint-disable-next-line no-console\n            console.error(prefix, ...args)\n        },\n\n        uninitializedWarning: (methodName: string) => {\n            logger.error(`You must initialize PostHog before calling ${methodName}`)\n        },\n\n        createLogger: (additionalPrefix: string, options?: CreateLoggerOptions) =>\n            _createLogger(`${prefix} ${additionalPrefix}`, options),\n    }\n    return logger\n}\n\nexport const logger = _createLogger('[PostHog.js]')\n\nexport const createLogger = logger.createLogger\n","/**\n * uuidv7: An experimental implementation of the proposed UUID Version 7\n *\n * @license Apache-2.0\n * @copyright 2021-2023 LiosK\n * @packageDocumentation\n *\n * from https://github.com/LiosK/uuidv7/blob/e501462ea3d23241de13192ceae726956f9b3b7d/src/index.ts\n */\n\n// polyfill for IE11\nimport { window } from './utils/globals'\n\nimport { isNumber, isUndefined } from '@posthog/core'\n\nif (!Math.trunc) {\n    Math.trunc = function (v) {\n        return v < 0 ? Math.ceil(v) : Math.floor(v)\n    }\n}\n\n// polyfill for IE11\nif (!Number.isInteger) {\n    Number.isInteger = function (value) {\n        return isNumber(value) && isFinite(value) && Math.floor(value) === value\n    }\n}\n\nconst DIGITS = '0123456789abcdef'\n\n/** Represents a UUID as a 16-byte byte array. */\nexport class UUID {\n    /** @param bytes - The 16-byte byte array representation. */\n    constructor(readonly bytes: Readonly<Uint8Array>) {\n        if (bytes.length !== 16) {\n            throw new TypeError('not 128-bit length')\n        }\n    }\n\n    /**\n     * Builds a byte array from UUIDv7 field values.\n     *\n     * @param unixTsMs - A 48-bit `unix_ts_ms` field value.\n     * @param randA - A 12-bit `rand_a` field value.\n     * @param randBHi - The higher 30 bits of 62-bit `rand_b` field value.\n     * @param randBLo - The lower 32 bits of 62-bit `rand_b` field value.\n     */\n    static fromFieldsV7(unixTsMs: number, randA: number, randBHi: number, randBLo: number): UUID {\n        if (\n            !Number.isInteger(unixTsMs) ||\n            !Number.isInteger(randA) ||\n            !Number.isInteger(randBHi) ||\n            !Number.isInteger(randBLo) ||\n            unixTsMs < 0 ||\n            randA < 0 ||\n            randBHi < 0 ||\n            randBLo < 0 ||\n            unixTsMs > 0xffff_ffff_ffff ||\n            randA > 0xfff ||\n            randBHi > 0x3fff_ffff ||\n            randBLo > 0xffff_ffff\n        ) {\n            throw new RangeError('invalid field value')\n        }\n\n        const bytes = new Uint8Array(16)\n        bytes[0] = unixTsMs / 2 ** 40\n        bytes[1] = unixTsMs / 2 ** 32\n        bytes[2] = unixTsMs / 2 ** 24\n        bytes[3] = unixTsMs / 2 ** 16\n        bytes[4] = unixTsMs / 2 ** 8\n        bytes[5] = unixTsMs\n        bytes[6] = 0x70 | (randA >>> 8)\n        bytes[7] = randA\n        bytes[8] = 0x80 | (randBHi >>> 24)\n        bytes[9] = randBHi >>> 16\n        bytes[10] = randBHi >>> 8\n        bytes[11] = randBHi\n        bytes[12] = randBLo >>> 24\n        bytes[13] = randBLo >>> 16\n        bytes[14] = randBLo >>> 8\n        bytes[15] = randBLo\n        return new UUID(bytes)\n    }\n\n    /** @returns The 8-4-4-4-12 canonical hexadecimal string representation. */\n    toString(): string {\n        let text = ''\n        for (let i = 0; i < this.bytes.length; i++) {\n            text = text + DIGITS.charAt(this.bytes[i] >>> 4) + DIGITS.charAt(this.bytes[i] & 0xf)\n            if (i === 3 || i === 5 || i === 7 || i === 9) {\n                text += '-'\n            }\n        }\n\n        if (text.length !== 36) {\n            // We saw one customer whose bundling code was mangling the UUID generation\n            // rather than accept a bad UUID, we throw an error here.\n            throw new Error('Invalid UUIDv7 was generated')\n        }\n        return text\n    }\n\n    /** Creates an object from `this`. */\n    clone(): UUID {\n        return new UUID(this.bytes.slice(0))\n    }\n\n    /** Returns true if `this` is equivalent to `other`. */\n    equals(other: UUID): boolean {\n        return this.compareTo(other) === 0\n    }\n\n    /**\n     * Returns a negative integer, zero, or positive integer if `this` is less\n     * than, equal to, or greater than `other`, respectively.\n     */\n    compareTo(other: UUID): number {\n        for (let i = 0; i < 16; i++) {\n            const diff = this.bytes[i] - other.bytes[i]\n            if (diff !== 0) {\n                return Math.sign(diff)\n            }\n        }\n        return 0\n    }\n}\n\n/** Encapsulates the monotonic counter state. */\nclass V7Generator {\n    private _timestamp = 0\n    private _counter = 0\n    private readonly _random = new DefaultRandom()\n\n    /**\n     * Generates a new UUIDv7 object from the current timestamp, or resets the\n     * generator upon significant timestamp rollback.\n     *\n     * This method returns monotonically increasing UUIDs unless the up-to-date\n     * timestamp is significantly (by ten seconds or more) smaller than the one\n     * embedded in the immediately preceding UUID. If such a significant clock\n     * rollback is detected, this method resets the generator and returns a new\n     * UUID based on the current timestamp.\n     */\n    generate(): UUID {\n        const value = this.generateOrAbort()\n        if (!isUndefined(value)) {\n            return value\n        } else {\n            // reset state and resume\n            this._timestamp = 0\n            const valueAfterReset = this.generateOrAbort()\n            if (isUndefined(valueAfterReset)) {\n                throw new Error('Could not generate UUID after timestamp reset')\n            }\n            return valueAfterReset\n        }\n    }\n\n    /**\n     * Generates a new UUIDv7 object from the current timestamp, or returns\n     * `undefined` upon significant timestamp rollback.\n     *\n     * This method returns monotonically increasing UUIDs unless the up-to-date\n     * timestamp is significantly (by ten seconds or more) smaller than the one\n     * embedded in the immediately preceding UUID. If such a significant clock\n     * rollback is detected, this method aborts and returns `undefined`.\n     */\n    generateOrAbort(): UUID | undefined {\n        const MAX_COUNTER = 0x3ff_ffff_ffff\n        const ROLLBACK_ALLOWANCE = 10_000 // 10 seconds\n\n        const ts = Date.now()\n        if (ts > this._timestamp) {\n            this._timestamp = ts\n            this._resetCounter()\n        } else if (ts + ROLLBACK_ALLOWANCE > this._timestamp) {\n            // go on with previous timestamp if new one is not much smaller\n            this._counter++\n            if (this._counter > MAX_COUNTER) {\n                // increment timestamp at counter overflow\n                this._timestamp++\n                this._resetCounter()\n            }\n        } else {\n            // abort if clock went backwards to unbearable extent\n            return undefined\n        }\n\n        return UUID.fromFieldsV7(\n            this._timestamp,\n            Math.trunc(this._counter / 2 ** 30),\n            this._counter & (2 ** 30 - 1),\n            this._random.nextUint32()\n        )\n    }\n\n    /** Initializes the counter at a 42-bit random integer. */\n    private _resetCounter(): void {\n        this._counter = this._random.nextUint32() * 0x400 + (this._random.nextUint32() & 0x3ff)\n    }\n}\n\n/** A global flag to force use of cryptographically strong RNG. */\ndeclare const UUIDV7_DENY_WEAK_RNG: boolean\n\n/** Stores `crypto.getRandomValues()` available in the environment. */\nlet getRandomValues: <T extends Uint8Array | Uint32Array>(buffer: T) => T = (buffer) => {\n    // fall back on Math.random() unless the flag is set to true\n    // TRICKY: don't use the isUndefined method here as can't pass the reference\n    if (typeof UUIDV7_DENY_WEAK_RNG !== 'undefined' && UUIDV7_DENY_WEAK_RNG) {\n        throw new Error('no cryptographically strong RNG available')\n    }\n\n    for (let i = 0; i < buffer.length; i++) {\n        buffer[i] = Math.trunc(Math.random() * 0x1_0000) * 0x1_0000 + Math.trunc(Math.random() * 0x1_0000)\n    }\n    return buffer\n}\n\n// detect Web Crypto API\nif (window && !isUndefined(window.crypto) && crypto.getRandomValues) {\n    getRandomValues = (buffer) => crypto.getRandomValues(buffer)\n}\n\n/**\n * Wraps `crypto.getRandomValues()` and compatibles to enable buffering; this\n * uses a small buffer by default to avoid unbearable throughput decline in some\n * environments as well as the waste of time and space for unused values.\n */\nclass DefaultRandom {\n    private readonly _buffer = new Uint32Array(8)\n    private _cursor = Infinity\n    nextUint32(): number {\n        if (this._cursor >= this._buffer.length) {\n            getRandomValues(this._buffer)\n            this._cursor = 0\n        }\n        return this._buffer[this._cursor++]\n    }\n}\n\nlet defaultGenerator: V7Generator | undefined\n\n/**\n * Generates a UUIDv7 string.\n *\n * @returns The 8-4-4-4-12 canonical hexadecimal string representation\n * (\"xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx\").\n */\nexport const uuidv7 = (): string => uuidv7obj().toString()\n\n/** Generates a UUIDv7 object. */\nconst uuidv7obj = (): UUID => (defaultGenerator || (defaultGenerator = new V7Generator())).generate()\n\nexport const uuid7ToTimestampMs = (uuid: string): number => {\n    // remove hyphens\n    const hex = uuid.replace(/-/g, '')\n    // ensure that it's a version 7 UUID\n    if (hex.length !== 32) {\n        throw new Error('Not a valid UUID')\n    }\n    if (hex[12] !== '7') {\n        throw new Error('Not a UUIDv7')\n    }\n    // the first 6 bytes are the timestamp, which means that we can read only the first 12 hex characters\n    return parseInt(hex.substring(0, 12), 16)\n}\n","import { PostHog } from '../../../posthog-core'\nimport { UserProvidedTraits } from '../../../posthog-conversations-types'\nimport { createLogger } from '../../../utils/logger'\nimport { uuidv7 } from '../../../uuidv7'\n\nconst logger = createLogger('[ConversationsPersistence]')\n\n// Persistence keys - defined here in the lazy-loaded extension bundle\n// These keys are also listed in constants.ts PERSISTENCE_RESERVED_PROPERTIES\n// to prevent them from being included in event properties\nconst CONVERSATIONS_WIDGET_SESSION_ID = '$conversations_widget_session_id'\nconst CONVERSATIONS_TICKET_ID = '$conversations_ticket_id'\nconst CONVERSATIONS_WIDGET_STATE = '$conversations_widget_state'\nconst CONVERSATIONS_USER_TRAITS = '$conversations_user_traits'\n\n/**\n * ConversationsPersistence manages conversation-related data using PostHog's\n * core persistence layer. This ensures the data respects user's persistence\n * preferences (localStorage, cookie, sessionStorage, memory) and consent settings.\n */\nexport class ConversationsPersistence {\n    private _cachedWidgetSessionId: string | null = null\n\n    constructor(private readonly _posthog: PostHog) {}\n\n    /** Check if persistence is available and enabled */\n    private _isPersistenceAvailable(): boolean {\n        return !!this._posthog.persistence && !this._posthog.persistence.isDisabled?.()\n    }\n\n    /**\n     * Get or create the widget session ID (random UUID for access control).\n     * This ID is generated once per browser and persists across sessions.\n     * It is NOT tied to distinct_id - it stays the same even when user identifies.\n     *\n     * SECURITY: This is the key for access control. Only the browser that created\n     * the widget_session_id can access tickets associated with it.\n     */\n    getOrCreateWidgetSessionId(): string {\n        // Return cached value if available\n        if (this._cachedWidgetSessionId) {\n            return this._cachedWidgetSessionId\n        }\n\n        // Check if persistence is available\n        if (!this._isPersistenceAvailable()) {\n            // Fallback: generate a new one each time (won't persist)\n            // This is acceptable for SSR or environments without persistence\n            const sessionId = uuidv7()\n            logger.warn('Persistence not available, widget_session_id will not persist', { sessionId })\n            return sessionId\n        }\n\n        try {\n            let sessionId = this._posthog.persistence?.get_property(CONVERSATIONS_WIDGET_SESSION_ID)\n            if (!sessionId) {\n                sessionId = uuidv7()\n                this._posthog.persistence?.register({ [CONVERSATIONS_WIDGET_SESSION_ID]: sessionId })\n            }\n            this._cachedWidgetSessionId = sessionId\n            return sessionId\n        } catch (error) {\n            logger.error('Failed to get/create widget_session_id', error)\n            // Fallback: generate a new one (won't persist)\n            return uuidv7()\n        }\n    }\n\n    /**\n     * Clear the widget session ID (called on posthog.reset()).\n     * This will create a new session and lose access to previous tickets.\n     */\n    clearWidgetSessionId(): void {\n        this._cachedWidgetSessionId = null\n\n        if (!this._isPersistenceAvailable()) {\n            return\n        }\n\n        try {\n            this._posthog.persistence?.unregister(CONVERSATIONS_WIDGET_SESSION_ID)\n            logger.info('Cleared widget_session_id')\n        } catch (error) {\n            logger.error('Failed to clear widget_session_id', error)\n        }\n    }\n\n    /**\n     * Save the current ticket ID to persistence\n     */\n    saveTicketId(ticketId: string): void {\n        if (!this._isPersistenceAvailable()) {\n            logger.warn('Persistence not available')\n            return\n        }\n\n        try {\n            this._posthog.persistence?.register({ [CONVERSATIONS_TICKET_ID]: ticketId })\n            logger.info('Saved ticket ID', { ticketId })\n        } catch (error) {\n            logger.error('Failed to save ticket ID', error)\n        }\n    }\n\n    /**\n     * Load the current ticket ID from persistence\n     */\n    loadTicketId(): string | null {\n        if (!this._isPersistenceAvailable()) {\n            logger.warn('Persistence not available')\n            return null\n        }\n\n        try {\n            const ticketId = this._posthog.persistence?.get_property(CONVERSATIONS_TICKET_ID)\n            if (ticketId) {\n                logger.info('Loaded ticket ID', { ticketId })\n            }\n            return ticketId || null\n        } catch (error) {\n            logger.error('Failed to load ticket ID', error)\n            return null\n        }\n    }\n\n    /**\n     * Clear the current ticket ID from persistence\n     */\n    clearTicketId(): void {\n        if (!this._isPersistenceAvailable()) {\n            logger.warn('Persistence not available')\n            return\n        }\n\n        try {\n            this._posthog.persistence?.unregister(CONVERSATIONS_TICKET_ID)\n            logger.info('Cleared ticket ID')\n        } catch (error) {\n            logger.error('Failed to clear ticket ID', error)\n        }\n    }\n\n    /**\n     * Save widget state (open, closed)\n     */\n    saveWidgetState(state: 'open' | 'closed'): void {\n        if (!this._isPersistenceAvailable()) {\n            return\n        }\n\n        try {\n            this._posthog.persistence?.register({ [CONVERSATIONS_WIDGET_STATE]: state })\n        } catch (error) {\n            logger.error('Failed to save widget state', error)\n        }\n    }\n\n    /**\n     * Load widget state\n     */\n    loadWidgetState(): 'open' | 'closed' | null {\n        if (!this._isPersistenceAvailable()) {\n            return null\n        }\n\n        try {\n            const state = this._posthog.persistence?.get_property(CONVERSATIONS_WIDGET_STATE)\n            if (state === 'open' || state === 'closed') {\n                return state\n            }\n            return null\n        } catch (error) {\n            logger.error('Failed to load widget state', error)\n            return null\n        }\n    }\n\n    /**\n     * Save user-provided traits (name, email) to persistence\n     */\n    saveUserTraits(traits: UserProvidedTraits): void {\n        if (!this._isPersistenceAvailable()) {\n            logger.warn('Persistence not available')\n            return\n        }\n\n        try {\n            this._posthog.persistence?.register({ [CONVERSATIONS_USER_TRAITS]: traits })\n            logger.info('Saved user traits', { hasName: !!traits.name, hasEmail: !!traits.email })\n        } catch (error) {\n            logger.error('Failed to save user traits', error)\n        }\n    }\n\n    /**\n     * Load user-provided traits from persistence\n     */\n    loadUserTraits(): UserProvidedTraits | null {\n        if (!this._isPersistenceAvailable()) {\n            return null\n        }\n\n        try {\n            const traits = this._posthog.persistence?.get_property(CONVERSATIONS_USER_TRAITS) as\n                | UserProvidedTraits\n                | undefined\n            if (traits) {\n                logger.info('Loaded user traits', { hasName: !!traits.name, hasEmail: !!traits.email })\n                return traits\n            }\n            return null\n        } catch (error) {\n            logger.error('Failed to load user traits', error)\n            return null\n        }\n    }\n\n    /**\n     * Clear user-provided traits from persistence\n     */\n    clearUserTraits(): void {\n        if (!this._isPersistenceAvailable()) {\n            return\n        }\n\n        try {\n            this._posthog.persistence?.unregister(CONVERSATIONS_USER_TRAITS)\n            logger.info('Cleared user traits')\n        } catch (error) {\n            logger.error('Failed to clear user traits', error)\n        }\n    }\n\n    /**\n     * Clear all conversation-related data from persistence.\n     * This is called on posthog.reset() to start fresh.\n     */\n    clearAll(): void {\n        if (!this._isPersistenceAvailable()) {\n            return\n        }\n\n        try {\n            // Clear all conversation properties\n            this._posthog.persistence?.unregister(CONVERSATIONS_WIDGET_STATE)\n            this._posthog.persistence?.unregister(CONVERSATIONS_USER_TRAITS)\n            this._posthog.persistence?.unregister(CONVERSATIONS_TICKET_ID)\n\n            // Clear widget session ID last (this will lose access to previous tickets)\n            this.clearWidgetSessionId()\n\n            logger.info('Cleared all conversation data')\n        } catch (error) {\n            logger.error('Failed to clear conversation data', error)\n        }\n    }\n}\n","// Inline styles following PostHog design system\nexport const getStyles = (primaryColor: string) => ({\n    widget: {\n        position: 'fixed' as const,\n        bottom: '20px',\n        right: '20px',\n        zIndex: 2147483647,\n        fontFamily: '-apple-system, BlinkMacSystemFont, \"Inter\", \"Segoe UI\", \"Roboto\", Helvetica, Arial, sans-serif',\n    },\n    buttonContainer: {\n        position: 'relative' as const,\n    },\n    button: {\n        width: '50px',\n        height: '50px',\n        borderRadius: '50%',\n        background: primaryColor,\n        color: 'white',\n        border: 'none',\n        cursor: 'pointer',\n        boxShadow: '0 4px 12px rgba(0, 0, 0, 0.15)',\n        display: 'flex',\n        alignItems: 'center',\n        justifyContent: 'center',\n        transition: 'transform 0.2s ease-out, box-shadow 0.2s ease-out',\n    },\n    unreadBadge: {\n        position: 'absolute' as const,\n        top: '-4px',\n        right: '-4px',\n        minWidth: '20px',\n        height: '20px',\n        borderRadius: '10px',\n        background: '#ef4444',\n        color: 'white',\n        fontSize: '11px',\n        fontWeight: 600,\n        display: 'flex',\n        alignItems: 'center',\n        justifyContent: 'center',\n        padding: '0 5px',\n        boxShadow: '0 2px 4px rgba(0, 0, 0, 0.2)',\n        border: '2px solid white',\n        boxSizing: 'border-box' as const,\n    },\n    window: {\n        position: 'absolute' as const,\n        bottom: 0,\n        right: 0,\n        background: 'white',\n        borderRadius: '10px',\n        boxShadow: '0 10px 25px -3px rgba(0,0,0,0.12), 0 4px 12px -2px rgba(0,0,0,0.10)',\n        display: 'flex',\n        flexDirection: 'column' as const,\n        overflow: 'hidden',\n        transition: 'all 0.3s cubic-bezier(0.4, 0, 0.2, 1)',\n        //border: '1px solid #dcdcdc',\n        border: 'none',\n    },\n    windowOpen: {\n        width: '400px',\n        height: '600px',\n        maxHeight: 'calc(100vh - 100px)',\n    },\n    header: {\n        background: primaryColor,\n        color: 'white',\n        padding: '8px 12px',\n        display: 'flex',\n        justifyContent: 'space-between',\n        alignItems: 'center',\n        flexShrink: 0,\n    },\n    headerTitle: {\n        fontWeight: 500,\n        fontSize: '14px',\n    },\n    headerActions: {\n        display: 'flex',\n        gap: '4px',\n    },\n    headerButton: {\n        background: 'transparent',\n        border: 'none',\n        color: 'white',\n        cursor: 'pointer',\n        padding: '6px 8px',\n        fontSize: '16px',\n        lineHeight: 1,\n        borderRadius: '4px',\n        transition: 'background 0.2s ease-out',\n        opacity: 0.9,\n    },\n    messages: {\n        flex: 1,\n        overflowY: 'auto' as const,\n        padding: '14px',\n        display: 'flex',\n        flexDirection: 'column' as const,\n        gap: '8px',\n        background: 'white',\n    },\n    message: {\n        display: 'flex',\n        flexDirection: 'column' as const,\n        maxWidth: '85%',\n        animation: 'fadeIn 0.2s ease-out',\n    },\n    messageCustomer: {\n        alignSelf: 'flex-end',\n        alignItems: 'flex-end',\n    },\n    messageAgent: {\n        alignSelf: 'flex-start',\n        alignItems: 'flex-start',\n    },\n    messageAuthor: {\n        fontSize: '10px',\n        color: '#939393',\n        marginBottom: '4px',\n        fontWeight: 500,\n    },\n    messageContent: {\n        padding: '8px 12px',\n        borderRadius: '8px',\n        fontSize: '12px',\n        lineHeight: 1.5,\n        wordWrap: 'break-word' as const,\n        whiteSpace: 'pre-wrap' as const,\n    },\n    messageContentCustomer: {\n        background: primaryColor,\n        color: 'white',\n        borderBottomRightRadius: '2px',\n    },\n    messageContentAgent: {\n        background: 'white',\n        color: '#020617',\n        border: '1.5px solid #dcdcdc',\n        borderBottomLeftRadius: '2px',\n    },\n    messageTime: {\n        fontSize: '10px',\n        color: '#939393',\n        marginTop: '4px',\n        opacity: 0.8,\n    },\n    typing: {\n        display: 'flex',\n        gap: '4px',\n        padding: '10px 14px',\n        alignItems: 'center',\n    },\n    typingDot: {\n        width: '6px',\n        height: '6px',\n        borderRadius: '50%',\n        background: '#939393',\n    },\n    error: {\n        padding: '10px 16px',\n        background: '#fee2e2',\n        color: '#991b1b',\n        fontSize: '13px',\n        borderTop: '1px solid #fecaca',\n        borderBottom: '1px solid #fecaca',\n        textAlign: 'center' as const,\n        fontWeight: 500,\n    },\n    inputContainer: {\n        padding: '8px 12px',\n        background: 'white',\n        borderTop: '1px solid #dcdcdc',\n        display: 'flex',\n        gap: '8px',\n        alignItems: 'center', // Changed from flex-end to center to vertically align input and sendButton\n        flexShrink: 0,\n    },\n    input: {\n        flex: 1,\n        maxHeight: '120px',\n        fontSize: '14px',\n        resize: 'vertical',\n        fontFamily: 'inherit',\n        lineHeight: 1.5,\n        color: '#020617',\n        background: 'white',\n        border: 'none',\n        outline: 'none',\n        transition: 'border-color 0.2s ease-out, box-shadow 0.2s ease-out',\n        display: 'flex',\n        alignItems: 'center',\n        fieldSizing: 'content',\n    },\n    sendButton: {\n        width: '33px',\n        height: '33px', // Match input minHeight for vertical alignment\n        borderRadius: '10px',\n        background: primaryColor,\n        color: 'white',\n        border: 'none',\n        cursor: 'pointer',\n        display: 'flex',\n        alignItems: 'center',\n        justifyContent: 'center',\n        transition: 'all 0.2s ease-out',\n        boxShadow: '0 2px 0 rgba(0, 0, 0, 0.045)',\n        fontWeight: 700,\n        flexShrink: 0,\n    },\n    // Identification form styles\n    identificationForm: {\n        flex: 1,\n        display: 'flex',\n        flexDirection: 'column' as const,\n        padding: '24px',\n        background: '#eeeded',\n        overflowY: 'auto' as const,\n    },\n    formTitle: {\n        fontSize: '18px',\n        fontWeight: 600,\n        color: '#020617',\n        marginBottom: '8px',\n    },\n    formDescription: {\n        fontSize: '14px',\n        color: '#64748b',\n        marginBottom: '24px',\n        lineHeight: 1.5,\n    },\n    formField: {\n        marginBottom: '16px',\n    },\n    formLabel: {\n        display: 'block',\n        fontSize: '13px',\n        fontWeight: 500,\n        color: '#020617',\n        marginBottom: '6px',\n    },\n    formInput: {\n        width: '100%',\n        padding: '10px 12px',\n        border: '1px solid #dcdcdc',\n        borderRadius: '6px',\n        fontSize: '14px',\n        fontFamily: 'inherit',\n        color: '#020617',\n        background: 'white',\n        transition: 'border-color 0.2s ease-out, box-shadow 0.2s ease-out',\n        boxSizing: 'border-box' as const,\n    },\n    formInputError: {\n        borderColor: '#ef4444',\n    },\n    formError: {\n        fontSize: '12px',\n        color: '#ef4444',\n        marginTop: '4px',\n    },\n    formSubmitButton: {\n        width: '100%',\n        padding: '12px 16px',\n        borderRadius: '6px',\n        background: primaryColor,\n        color: 'white',\n        border: 'none',\n        cursor: 'pointer',\n        fontSize: '14px',\n        fontWeight: 600,\n        transition: 'all 0.2s ease-out',\n        marginTop: '8px',\n    },\n    formOptional: {\n        fontSize: '12px',\n        color: '#939393',\n        fontWeight: 400,\n    },\n})\n","import { getStyles } from './styles'\n\ninterface OpenChatButtonProps {\n    primaryColor: string\n    handleToggleOpen: () => void\n    unreadCount?: number\n}\n\nexport const OpenChatButton = ({ primaryColor, handleToggleOpen, unreadCount = 0 }: OpenChatButtonProps) => {\n    const styles = getStyles(primaryColor)\n    const displayCount = unreadCount > 99 ? '99+' : unreadCount.toString()\n\n    return (\n        <div style={styles.widget}>\n            <div style={styles.buttonContainer}>\n                <button\n                    style={styles.button}\n                    onClick={handleToggleOpen}\n                    aria-label={unreadCount > 0 ? `Open chat (${unreadCount} unread)` : 'Open chat'}\n                    onMouseEnter={(e) => {\n                        e.currentTarget.style.transform = 'scale(1.05)'\n                        e.currentTarget.style.boxShadow = '0 6px 20px rgba(0, 0, 0, 0.2)'\n                    }}\n                    onMouseLeave={(e) => {\n                        e.currentTarget.style.transform = 'scale(1)'\n                        e.currentTarget.style.boxShadow = '0 4px 12px rgba(0, 0, 0, 0.15)'\n                    }}\n                >\n                    <svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" fill=\"none\" xmlns=\"http://www.w3.org/2000/svg\">\n                        <path\n                            d=\"M12 2C6.48 2 2 6.48 2 12C2 13.93 2.6 15.71 3.64 17.18L2.5 21.5L7.04 20.42C8.46 21.28 10.17 21.75 12 21.75C17.52 21.75 22 17.27 22 11.75C22 6.23 17.52 2 12 2Z\"\n                            fill=\"currentColor\"\n                        />\n                    </svg>\n                </button>\n                {unreadCount > 0 && <div style={styles.unreadBadge}>{displayCount}</div>}\n            </div>\n        </div>\n    )\n}\n","import { getStyles } from './styles'\n\ninterface SendMessageButtonProps {\n    primaryColor: string\n    inputValue: string\n    isLoading: boolean\n    handleSendMessage: () => void\n}\n\nexport const SendMessageButton = ({\n    primaryColor,\n    inputValue,\n    isLoading,\n    handleSendMessage,\n}: SendMessageButtonProps) => {\n    const styles = getStyles(primaryColor)\n    return (\n        <button\n            style={{\n                ...styles.sendButton,\n                opacity: !inputValue.trim() || isLoading ? 0.6 : 1,\n                cursor: !inputValue.trim() || isLoading ? 'not-allowed' : 'pointer',\n            }}\n            onClick={handleSendMessage}\n            disabled={!inputValue.trim() || isLoading}\n            aria-label=\"Send message\"\n            onMouseEnter={(e) => {\n                if (!e.currentTarget.disabled) {\n                    e.currentTarget.style.transform = 'scale(1.02)'\n                    e.currentTarget.style.boxShadow = '0 4px 8px rgba(0, 0, 0, 0.1)'\n                }\n            }}\n            onMouseLeave={(e) => {\n                e.currentTarget.style.transform = 'scale(1)'\n                e.currentTarget.style.boxShadow = '0 2px 0 rgba(0, 0, 0, 0.045)'\n            }}\n        >\n            <svg width=\"20\" height=\"20\" viewBox=\"0 0 20 20\" fill=\"none\" xmlns=\"http://www.w3.org/2000/svg\">\n                <path\n                    d=\"M2 10L18 2L10 18L8 11L2 10Z\"\n                    fill=\"currentColor\"\n                    stroke=\"currentColor\"\n                    strokeWidth=\"2\"\n                    strokeLinejoin=\"round\"\n                />\n            </svg>\n        </button>\n    )\n}\n","import { getStyles } from './styles'\n\ninterface CloseChatButtonProps {\n    primaryColor: string\n    handleClose: () => void\n}\n\nexport const CloseChatButton = ({ primaryColor, handleClose }: CloseChatButtonProps) => {\n    const styles = getStyles(primaryColor)\n    return (\n        <button\n            style={styles.headerButton}\n            onClick={handleClose}\n            aria-label=\"Close\"\n            onMouseEnter={(e) => {\n                e.currentTarget.style.background = 'rgba(255, 255, 255, 0.15)'\n                e.currentTarget.style.opacity = '1'\n            }}\n            onMouseLeave={(e) => {\n                e.currentTarget.style.background = 'transparent'\n                e.currentTarget.style.opacity = '0.9'\n            }}\n        >\n            \n        </button>\n    )\n}\n","// eslint-disable-next-line @typescript-eslint/no-unused-vars\nimport { h, Component, Fragment } from 'preact'\nimport {\n    ConversationsRemoteConfig,\n    Message,\n    ConversationsWidgetState,\n    UserProvidedTraits,\n} from '../../../../posthog-conversations-types'\nimport { createLogger } from '../../../../utils/logger'\nimport { getStyles } from './styles'\nimport { OpenChatButton } from './OpenChatButton'\nimport { SendMessageButton } from './SendMessageButton'\nimport { CloseChatButton } from './CloseChatButton'\n\nconst logger = createLogger('[ConversationsWidget]')\n\ninterface WidgetProps {\n    config: ConversationsRemoteConfig\n    initialState?: ConversationsWidgetState\n    initialUserTraits?: UserProvidedTraits | null\n    onSendMessage: (message: string) => Promise<void>\n    onStateChange?: (state: ConversationsWidgetState) => void\n    onIdentify?: (traits: UserProvidedTraits) => void\n}\n\ninterface WidgetState {\n    state: ConversationsWidgetState\n    messages: Message[]\n    inputValue: string\n    isLoading: boolean\n    error: string | null\n    showIdentificationForm: boolean\n    formName: string\n    formEmail: string\n    formEmailError: string | null\n    userTraits: UserProvidedTraits | null\n    unreadCount: number\n}\n\nexport class ConversationsWidget extends Component<WidgetProps, WidgetState> {\n    private _messagesEndRef: HTMLDivElement | null = null\n    private _inputRef: HTMLTextAreaElement | null = null\n\n    constructor(props: WidgetProps) {\n        super(props)\n\n        // Determine if we need to show the identification form\n        const userTraits = props.initialUserTraits || null\n        const needsIdentification = this._needsIdentification(props.config, userTraits)\n\n        this.state = {\n            state: props.initialState || 'closed',\n            messages: [],\n            inputValue: '',\n            isLoading: false,\n            error: null,\n            showIdentificationForm: needsIdentification,\n            formName: userTraits?.name || '',\n            formEmail: userTraits?.email || '',\n            formEmailError: null,\n            userTraits,\n            unreadCount: 0,\n        }\n    }\n\n    /**\n     * Check if we need to show the identification form\n     */\n    private _needsIdentification(config: ConversationsRemoteConfig, traits: UserProvidedTraits | null): boolean {\n        // If requireEmail is not set, no identification needed\n        if (!config.requireEmail) {\n            //return false\n        }\n\n        // If we already have an email, no form needed\n        if (traits?.email) {\n            return false\n        }\n\n        return true\n    }\n\n    componentDidMount() {\n        // Add greeting message if no messages exist\n        if (this.state.messages.length === 0 && this.props.config.greetingText) {\n            this._addGreetingMessage()\n        }\n    }\n\n    componentDidUpdate(_prevProps: WidgetProps, prevState: WidgetState) {\n        // Scroll to bottom when messages change\n        if (this.state.messages.length !== prevState.messages.length) {\n            this._scrollToBottom()\n        }\n\n        // Notify parent of state changes\n        if (this.state.state !== prevState.state && this.props.onStateChange) {\n            this.props.onStateChange(this.state.state)\n        }\n\n        // Focus input and scroll to bottom when opening\n        if (this.state.state === 'open' && prevState.state !== 'open') {\n            this._focusInput()\n            this._scrollToBottom()\n        }\n    }\n\n    private _addGreetingMessage() {\n        const greetingMessage: Message = {\n            id: 'greeting',\n            content: this.props.config.greetingText || 'Hi! How can we help?',\n            author_type: 'AI',\n            author_name: 'Support',\n            created_at: new Date().toISOString(),\n            is_private: false,\n        }\n        this.setState({ messages: [greetingMessage] })\n    }\n\n    private _scrollToBottom() {\n        if (this._messagesEndRef) {\n            this._messagesEndRef.scrollIntoView({ behavior: 'smooth' })\n        }\n    }\n\n    private _focusInput() {\n        if (this._inputRef) {\n            this._inputRef.focus()\n        }\n    }\n\n    private _handleToggleOpen = () => {\n        this.setState((prevState) => ({\n            state: prevState.state === 'open' ? 'closed' : 'open',\n        }))\n    }\n\n    private _handleClose = () => {\n        this.setState({ state: 'closed' })\n    }\n\n    private _handleInputChange = (e: Event) => {\n        const target = e.target as HTMLTextAreaElement\n        this.setState({ inputValue: target.value })\n    }\n\n    private _handleKeyPress = (e: KeyboardEvent) => {\n        if (e.key === 'Enter' && !e.shiftKey) {\n            e.preventDefault()\n            this._handleSendMessage()\n        }\n    }\n\n    // Identification form handlers\n    private _handleFormNameChange = (e: Event) => {\n        const target = e.target as HTMLInputElement\n        this.setState({ formName: target.value })\n    }\n\n    private _handleFormEmailChange = (e: Event) => {\n        const target = e.target as HTMLInputElement\n        this.setState({ formEmail: target.value, formEmailError: null })\n    }\n\n    private _validateEmail(email: string): boolean {\n        // Basic email validation\n        const emailRegex = /^[^\\s@]+@[^\\s@]+\\.[^\\s@]+$/\n        return emailRegex.test(email)\n    }\n\n    private _handleFormSubmit = (e: Event) => {\n        e.preventDefault()\n\n        const { formEmail, formName } = this.state\n        const { config, onIdentify } = this.props\n\n        // Validate email if required\n        if (config.requireEmail && !formEmail.trim()) {\n            this.setState({ formEmailError: 'Email is required' })\n            return\n        }\n\n        if (formEmail.trim() && !this._validateEmail(formEmail.trim())) {\n            this.setState({ formEmailError: 'Please enter a valid email address' })\n            return\n        }\n\n        // Create traits object\n        const traits: UserProvidedTraits = {}\n        if (formName.trim()) {\n            traits.name = formName.trim()\n        }\n        if (formEmail.trim()) {\n            traits.email = formEmail.trim()\n        }\n\n        // Update state and notify parent\n        this.setState({\n            userTraits: traits,\n            showIdentificationForm: false,\n        })\n\n        if (onIdentify) {\n            onIdentify(traits)\n        }\n    }\n\n    private _handleSendMessage = async () => {\n        const { inputValue } = this.state\n        const trimmedMessage = inputValue.trim()\n\n        if (!trimmedMessage) {\n            return\n        }\n\n        // Add user message to UI immediately\n        const userMessage: Message = {\n            id: `temp-${Date.now()}`,\n            content: trimmedMessage,\n            author_type: 'customer',\n            author_name: 'You',\n            created_at: new Date().toISOString(),\n            is_private: false,\n        }\n\n        this.setState({\n            messages: [...this.state.messages, userMessage],\n            inputValue: '',\n            isLoading: true,\n            error: null,\n        })\n\n        try {\n            await this.props.onSendMessage(trimmedMessage)\n            // Success - message will be updated via addMessage()\n            this.setState({ isLoading: false })\n        } catch (error) {\n            logger.error('Failed to send message', error)\n            this.setState({\n                isLoading: false,\n                error: error instanceof Error ? error.message : 'Failed to send message',\n            })\n\n            // Remove the temporary message on error\n            this.setState((prevState) => ({\n                messages: prevState.messages.filter((m) => m.id !== userMessage.id),\n            }))\n        }\n    }\n\n    private _formatTime(isoString: string): string {\n        const date = new Date(isoString)\n        const now = new Date()\n        const diffMs = now.getTime() - date.getTime()\n        const diffMins = Math.floor(diffMs / 60000)\n\n        if (diffMins < 1) {\n            return 'Just now'\n        } else if (diffMins < 60) {\n            return `${diffMins}m ago`\n        } else if (diffMins < 1440) {\n            return `${Math.floor(diffMins / 60)}h ago`\n        } else {\n            return date.toLocaleDateString()\n        }\n    }\n\n    /**\n     * Public method to add messages from outside\n     */\n    addMessages(messages: Message[]) {\n        this.setState((prevState) => {\n            // Filter out duplicates\n            const existingIds = new Set(prevState.messages.map((m) => m.id))\n            const newMessages = messages.filter((m) => !existingIds.has(m.id))\n\n            if (newMessages.length > 0) {\n                return {\n                    messages: [...prevState.messages, ...newMessages],\n                }\n            }\n            return null\n        })\n    }\n\n    /**\n     * Public method to show the widget\n     */\n    show() {\n        this.setState({ state: 'open' })\n    }\n\n    /**\n     * Public method to hide the widget\n     */\n    hide() {\n        this.setState({ state: 'closed' })\n    }\n\n    /**\n     * Public method to close the widget completely\n     */\n    close() {\n        this.setState({ state: 'closed' })\n    }\n\n    /**\n     * Get user traits (either provided via form or from props)\n     */\n    getUserTraits(): UserProvidedTraits | null {\n        return this.state.userTraits\n    }\n\n    /**\n     * Set the unread message count (called by manager)\n     */\n    setUnreadCount(count: number): void {\n        this.setState({ unreadCount: count })\n    }\n\n    private _renderIdentificationForm(styles: ReturnType<typeof getStyles>) {\n        const { config } = this.props\n        const { formName, formEmail, formEmailError } = this.state\n\n        const title = config.identificationFormTitle || 'Before we start...'\n        const description =\n            config.identificationFormDescription || 'Please provide your details so we can help you better.'\n        const showNameField = config.collectName !== false // Show by default unless explicitly disabled\n\n        return (\n            <div style={styles.identificationForm}>\n                <div style={styles.formTitle}>{title}</div>\n                <div style={styles.formDescription}>{description}</div>\n\n                <form onSubmit={this._handleFormSubmit}>\n                    {showNameField && (\n                        <div style={styles.formField}>\n                            <label style={styles.formLabel}>\n                                Name <span style={styles.formOptional}>(optional)</span>\n                            </label>\n                            <input\n                                type=\"text\"\n                                style={styles.formInput}\n                                value={formName}\n                                onInput={this._handleFormNameChange}\n                                placeholder=\"Your name\"\n                                autoComplete=\"name\"\n                            />\n                        </div>\n                    )}\n\n                    <div style={styles.formField}>\n                        <label style={styles.formLabel}>\n                            Email {!config.requireEmail && <span style={styles.formOptional}>(optional)</span>}\n                        </label>\n                        <input\n                            type=\"email\"\n                            style={{\n                                ...styles.formInput,\n                                ...(formEmailError ? styles.formInputError : {}),\n                            }}\n                            value={formEmail}\n                            onInput={this._handleFormEmailChange}\n                            placeholder=\"you@example.com\"\n                            autoComplete=\"email\"\n                        />\n                        {formEmailError && <div style={styles.formError}>{formEmailError}</div>}\n                    </div>\n\n                    <button\n                        type=\"submit\"\n                        style={styles.formSubmitButton}\n                        onMouseEnter={(e) => {\n                            e.currentTarget.style.opacity = '0.9'\n                        }}\n                        onMouseLeave={(e) => {\n                            e.currentTarget.style.opacity = '1'\n                        }}\n                    >\n                        Start Chat\n                    </button>\n                </form>\n            </div>\n        )\n    }\n\n    private _renderMessage(message: Message, styles: ReturnType<typeof getStyles>) {\n        const isCustomer = message.author_type === 'customer'\n        const messageStyle = {\n            ...styles.message,\n            ...(isCustomer ? styles.messageCustomer : styles.messageAgent),\n        }\n        const contentStyle = {\n            ...styles.messageContent,\n            ...(isCustomer ? styles.messageContentCustomer : styles.messageContentAgent),\n        }\n\n        return (\n            <div key={message.id} style={messageStyle}>\n                {!isCustomer && message.author_name && <div style={styles.messageAuthor}>{message.author_name}</div>}\n                <div style={contentStyle}>{message.content}</div>\n                <div style={styles.messageTime}>{this._formatTime(message.created_at)}</div>\n            </div>\n        )\n    }\n\n    render() {\n        const { config } = this.props\n        const { state, messages, inputValue, isLoading, error, showIdentificationForm } = this.state\n        const primaryColor = config.color || '#5375ff'\n        const placeholderText = config.placeholderText || 'Type your message...'\n        const styles = getStyles(primaryColor)\n\n        // Button only (closed state)\n        if (state === 'closed') {\n            return (\n                <OpenChatButton\n                    primaryColor={primaryColor}\n                    handleToggleOpen={this._handleToggleOpen}\n                    unreadCount={this.state.unreadCount}\n                />\n            )\n        }\n\n        // Open state\n        const windowStyle = {\n            ...styles.window,\n            ...styles.windowOpen,\n        }\n\n        return (\n            <div style={styles.widget}>\n                <div style={windowStyle}>\n                    {/* Header */}\n                    <div style={styles.header}>\n                        <div style={styles.headerTitle}>\n                            <span>Support Chat</span>\n                        </div>\n                        <div style={styles.headerActions}>\n                            <CloseChatButton primaryColor={primaryColor} handleClose={this._handleClose} />\n                        </div>\n                    </div>\n\n                    {/* Show identification form if needed, otherwise show chat */}\n                    {showIdentificationForm ? (\n                        this._renderIdentificationForm(styles)\n                    ) : (\n                        <>\n                            <div style={styles.messages}>\n                                {messages.map((message) => this._renderMessage(message, styles))}\n                                {isLoading && (\n                                    <div style={{ ...styles.message, ...styles.messageAgent }}>\n                                        <div\n                                            style={{\n                                                ...styles.messageContent,\n                                                ...styles.messageContentAgent,\n                                                ...styles.typing,\n                                            }}\n                                        >\n                                            <span style={styles.typingDot}></span>\n                                            <span style={{ ...styles.typingDot, animationDelay: '0.2s' }}></span>\n                                            <span style={{ ...styles.typingDot, animationDelay: '0.4s' }}></span>\n                                        </div>\n                                    </div>\n                                )}\n                                <div ref={(el) => (this._messagesEndRef = el)} />\n                            </div>\n\n                            {/* Error message */}\n                            {error && <div style={styles.error}>{error}</div>}\n\n                            {/* Input */}\n                            <div style={styles.inputContainer}>\n                                <textarea\n                                    ref={(el) => (this._inputRef = el)}\n                                    style={styles.input}\n                                    placeholder={placeholderText}\n                                    value={inputValue}\n                                    onInput={this._handleInputChange}\n                                    onKeyPress={this._handleKeyPress}\n                                    rows={1}\n                                    disabled={isLoading}\n                                />\n                                <SendMessageButton\n                                    primaryColor={primaryColor}\n                                    inputValue={inputValue}\n                                    isLoading={isLoading}\n                                    handleSendMessage={this._handleSendMessage}\n                                />\n                            </div>\n                        </>\n                    )}\n                </div>\n            </div>\n        )\n    }\n}\n","import { Breaker, Properties } from '../types'\nimport { nativeForEach, nativeIndexOf } from './globals'\nimport { logger } from './logger'\nimport { isFormData, isNull, isNullish, isNumber, isString, isUndefined, hasOwnProperty, isArray } from '@posthog/core'\n\nconst breaker: Breaker = {}\n\nexport function eachArray<E = any>(\n    obj: E[] | null | undefined,\n    iterator: (value: E, key: number) => void | Breaker,\n    thisArg?: any\n): void {\n    if (isArray(obj)) {\n        if (nativeForEach && obj.forEach === nativeForEach) {\n            obj.forEach(iterator, thisArg)\n        } else if ('length' in obj && obj.length === +obj.length) {\n            for (let i = 0, l = obj.length; i < l; i++) {\n                if (i in obj && iterator.call(thisArg, obj[i], i) === breaker) {\n                    return\n                }\n            }\n        }\n    }\n}\n\n/**\n * @param {*=} obj\n * @param {function(...*)=} iterator\n * @param {Object=} thisArg\n */\nexport function each(obj: any, iterator: (value: any, key: any) => void | Breaker, thisArg?: any): void {\n    if (isNullish(obj)) {\n        return\n    }\n    if (isArray(obj)) {\n        return eachArray(obj, iterator, thisArg)\n    }\n    if (isFormData(obj)) {\n        for (const pair of obj.entries()) {\n            if (iterator.call(thisArg, pair[1], pair[0]) === breaker) {\n                return\n            }\n        }\n        return\n    }\n    for (const key in obj) {\n        if (hasOwnProperty.call(obj, key)) {\n            if (iterator.call(thisArg, obj[key], key) === breaker) {\n                return\n            }\n        }\n    }\n}\n\nexport const extend = function (obj: Record<string, any>, ...args: Record<string, any>[]): Record<string, any> {\n    eachArray(args, function (source) {\n        for (const prop in source) {\n            if (source[prop] !== void 0) {\n                obj[prop] = source[prop]\n            }\n        }\n    })\n    return obj\n}\n\nexport const extendArray = function <T>(obj: T[], ...args: T[][]): T[] {\n    eachArray(args, function (source) {\n        eachArray(source, function (item) {\n            obj.push(item)\n        })\n    })\n    return obj\n}\n\nexport const include = function (\n    obj: null | string | Array<any> | Record<string, any>,\n    target: any\n): boolean | Breaker {\n    let found = false\n    if (isNull(obj)) {\n        return found\n    }\n    if (nativeIndexOf && obj.indexOf === nativeIndexOf) {\n        return obj.indexOf(target) != -1\n    }\n    each(obj, function (value) {\n        if (found || (found = value === target)) {\n            return breaker\n        }\n        return\n    })\n    return found\n}\n\n/**\n * Object.entries() polyfill\n * https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object/entries\n */\nexport function entries<T = any>(obj: Record<string, T>): [string, T][] {\n    const ownProps = Object.keys(obj)\n    let i = ownProps.length\n    const resArray = new Array(i) // preallocate the Array\n\n    while (i--) {\n        resArray[i] = [ownProps[i], obj[ownProps[i]]]\n    }\n    return resArray\n}\n\nexport const trySafe = function <T>(fn: () => T): T | undefined {\n    try {\n        return fn()\n    } catch {\n        return undefined\n    }\n}\n\nexport const safewrap = function <F extends (...args: any[]) => any = (...args: any[]) => any>(f: F): F {\n    return function (...args) {\n        try {\n            // eslint-disable-next-line @typescript-eslint/ban-ts-comment\n            // @ts-ignore\n            return f.apply(this, args)\n        } catch (e) {\n            logger.critical(\n                'Implementation error. Please turn on debug mode and open a ticket on https://app.posthog.com/home#panel=support%3Asupport%3A.'\n            )\n            logger.critical(e)\n        }\n    } as F\n}\n\n// eslint-disable-next-line @typescript-eslint/no-unsafe-function-type\nexport const safewrapClass = function (klass: Function, functions: string[]): void {\n    for (let i = 0; i < functions.length; i++) {\n        klass.prototype[functions[i]] = safewrap(klass.prototype[functions[i]])\n    }\n}\n\nexport const stripEmptyProperties = function (p: Properties): Properties {\n    const ret: Properties = {}\n    each(p, function (v, k) {\n        if ((isString(v) && v.length > 0) || isNumber(v)) {\n            ret[k] = v\n        }\n    })\n    return ret\n}\n\n/**\n * Deep copies an object.\n * It handles cycles by replacing all references to them with `undefined`\n * Also supports customizing native values\n *\n * @param value\n * @param customizer\n * @returns {{}|undefined|*}\n */\nfunction deepCircularCopy<T extends Record<string, any> = Record<string, any>>(\n    value: T,\n    customizer?: <K extends keyof T = keyof T>(value: T[K], key?: K) => T[K]\n): T | undefined {\n    const COPY_IN_PROGRESS_SET = new Set()\n\n    function internalDeepCircularCopy(value: T, key?: string): T | undefined {\n        if (value !== Object(value)) return customizer ? customizer(value as any, key) : value // primitive value\n\n        if (COPY_IN_PROGRESS_SET.has(value)) return undefined\n        COPY_IN_PROGRESS_SET.add(value)\n        let result: T\n\n        if (isArray(value)) {\n            result = [] as any as T\n            eachArray(value, (it) => {\n                result.push(internalDeepCircularCopy(it))\n            })\n        } else {\n            result = {} as T\n            each(value, (val, key) => {\n                if (!COPY_IN_PROGRESS_SET.has(val)) {\n                    ;(result as any)[key] = internalDeepCircularCopy(val, key)\n                }\n            })\n        }\n        return result\n    }\n    return internalDeepCircularCopy(value)\n}\n\nexport function _copyAndTruncateStrings<T extends Record<string, any> = Record<string, any>>(\n    object: T,\n    maxStringLength: number | null\n): T {\n    return deepCircularCopy(object, (value: any) => {\n        if (isString(value) && !isNull(maxStringLength)) {\n            return (value as string).slice(0, maxStringLength)\n        }\n        return value\n    }) as T\n}\n\n// NOTE: Update PostHogConfig docs if you change this list\n// We will not try to catch all bullets here, but we should make an effort to catch the most common ones\n// You should be highly against adding more to this list, because ultimately customers can configure\n// their `cross_subdomain_cookie` setting to anything they want.\nconst EXCLUDED_FROM_CROSS_SUBDOMAIN_COOKIE = ['herokuapp.com', 'vercel.app', 'netlify.app']\nexport function isCrossDomainCookie(documentLocation: Location | undefined) {\n    const hostname = documentLocation?.hostname\n\n    if (!isString(hostname)) {\n        return false\n    }\n    // split and slice isn't a great way to match arbitrary domains,\n    // but it's good enough for ensuring we only match herokuapp.com when it is the TLD\n    // for the hostname\n    const lastTwoParts = hostname.split('.').slice(-2).join('.')\n\n    for (const excluded of EXCLUDED_FROM_CROSS_SUBDOMAIN_COOKIE) {\n        if (lastTwoParts === excluded) {\n            return false\n        }\n    }\n\n    return true\n}\n\nexport function find<T>(value: T[], predicate: (value: T) => boolean): T | undefined {\n    for (let i = 0; i < value.length; i++) {\n        if (predicate(value[i])) {\n            return value[i]\n        }\n    }\n    return undefined\n}\n\n// Use this instead of element.addEventListener to avoid eslint errors\n// this properly implements the default options for passive event listeners\nexport function addEventListener(\n    element: Window | Document | Element | undefined,\n    event: string,\n    callback: EventListener,\n    options?: AddEventListenerOptions\n): void {\n    const { capture = false, passive = true } = options ?? {}\n\n    // This is the only place where we are allowed to call this function\n    // because the whole idea is that we should be calling this instead of the built-in one\n    // eslint-disable-next-line posthog-js/no-add-event-listener\n    element?.addEventListener(event, callback, { capture, passive })\n}\n\n/**\n * Helper to migrate deprecated config fields to new field names with appropriate warnings\n * @param config - The config object to check\n * @param newField - The new field name to use\n * @param oldField - The deprecated field name to check for\n * @param defaultValue - The default value if neither field is set\n * @param loggerInstance - Optional logger instance for deprecation warnings\n * @returns The value to use (new field takes precedence over old field)\n */\nexport function migrateConfigField<T>(\n    config: Record<string, any>,\n    newField: string,\n    oldField: string,\n    defaultValue: T,\n    loggerInstance?: { warn: (message: string) => void }\n): T {\n    const hasNewField = newField in config && !isUndefined(config[newField])\n    const hasOldField = oldField in config && !isUndefined(config[oldField])\n\n    if (hasNewField) {\n        return config[newField]\n    }\n\n    if (hasOldField) {\n        if (loggerInstance) {\n            loggerInstance.warn(\n                `Config field '${oldField}' is deprecated. Please use '${newField}' instead. ` +\n                    `The old field will be removed in a future major version.`\n            )\n        }\n        return config[oldField]\n    }\n\n    return defaultValue\n}\n","import { each } from './'\n\nimport { isArray, isFile, isUndefined } from '@posthog/core'\nimport { logger } from './logger'\nimport { document } from './globals'\n\nconst localDomains = ['localhost', '127.0.0.1']\n\n/**\n * IE11 doesn't support `new URL`\n * so we can create an anchor element and use that to parse the URL\n * there's a lot of overlap between HTMLHyperlinkElementUtils and URL\n * meaning useful properties like `pathname` are available on both\n */\nexport const convertToURL = (url: string): HTMLAnchorElement | null => {\n    const location = document?.createElement('a')\n    if (isUndefined(location)) {\n        return null\n    }\n\n    location.href = url\n    return location\n}\n\nexport const formDataToQuery = function (formdata: Record<string, any> | FormData, arg_separator = '&'): string {\n    let use_val: string\n    let use_key: string\n    const tph_arr: string[] = []\n\n    each(formdata, function (val: File | string | undefined, key: string | undefined) {\n        // the key might be literally the string undefined for e.g. if {undefined: 'something'}\n        if (isUndefined(val) || isUndefined(key) || key === 'undefined') {\n            return\n        }\n\n        use_val = encodeURIComponent(isFile(val) ? val.name : val.toString())\n        use_key = encodeURIComponent(key)\n        tph_arr[tph_arr.length] = use_key + '=' + use_val\n    })\n\n    return tph_arr.join(arg_separator)\n}\n\n// NOTE: Once we get rid of IE11/op_mini we can start using URLSearchParams\nexport const getQueryParam = function (url: string, param: string): string {\n    const withoutHash: string = url.split('#')[0] || ''\n\n    // Split only on the first ? to sort problem out for those with multiple ?s\n    // and then remove them\n    const queryParams: string = withoutHash.split(/\\?(.*)/)[1] || ''\n    const cleanedQueryParams = queryParams.replace(/^\\?+/g, '')\n\n    const queryParts = cleanedQueryParams.split('&')\n    let keyValuePair\n\n    for (let i = 0; i < queryParts.length; i++) {\n        const parts = queryParts[i].split('=')\n        if (parts[0] === param) {\n            keyValuePair = parts\n            break\n        }\n    }\n\n    if (!isArray(keyValuePair) || keyValuePair.length < 2) {\n        return ''\n    } else {\n        let result = keyValuePair[1]\n        try {\n            result = decodeURIComponent(result)\n        } catch {\n            logger.error('Skipping decoding for malformed query param: ' + result)\n        }\n        return result.replace(/\\+/g, ' ')\n    }\n}\n\n// replace any query params in the url with the provided mask value. Tries to keep the URL as instant as possible,\n// including preserving malformed text in most cases\nexport const maskQueryParams = function <T extends string | undefined>(\n    url: T,\n    maskedParams: string[] | undefined,\n    mask: string\n): T extends string ? string : undefined {\n    if (!url || !maskedParams || !maskedParams.length) {\n        return url as any\n    }\n\n    const splitHash = url.split('#')\n    const withoutHash: string = splitHash[0] || ''\n    const hash = splitHash[1]\n\n    const splitQuery: string[] = withoutHash.split('?')\n    const queryString: string = splitQuery[1]\n    const urlWithoutQueryAndHash: string = splitQuery[0]\n    const queryParts = (queryString || '').split('&')\n\n    // use an array of strings rather than an object to preserve ordering and duplicates\n    const paramStrings: string[] = []\n\n    for (let i = 0; i < queryParts.length; i++) {\n        const keyValuePair = queryParts[i].split('=')\n        if (!isArray(keyValuePair)) {\n            continue\n        } else if (maskedParams.includes(keyValuePair[0])) {\n            paramStrings.push(keyValuePair[0] + '=' + mask)\n        } else {\n            paramStrings.push(queryParts[i])\n        }\n    }\n\n    let result = urlWithoutQueryAndHash\n    if (queryString != null) {\n        result += '?' + paramStrings.join('&')\n    }\n    if (hash != null) {\n        result += '#' + hash\n    }\n\n    return result as any\n}\n\nexport const _getHashParam = function (hash: string, param: string): string | null {\n    const matches = hash.match(new RegExp(param + '=([^&]*)'))\n    return matches ? matches[1] : null\n}\n\nexport const isLocalhost = (): boolean => {\n    return localDomains.includes(location.hostname)\n}\n","// eslint-disable-next-line @typescript-eslint/no-unused-vars\nimport { render, h } from 'preact'\nimport { isNumber } from '@posthog/core'\nimport {\n    ConversationsRemoteConfig,\n    ConversationsWidgetState,\n    UserProvidedTraits,\n    SendMessageResponse,\n    GetMessagesResponse,\n    MarkAsReadResponse,\n} from '../../../posthog-conversations-types'\nimport { PostHog } from '../../../posthog-core'\nimport { ConversationsManager as ConversationsManagerInterface } from '../posthog-conversations'\nimport { ConversationsPersistence } from './persistence'\nimport { ConversationsWidget } from './components/ConversationsWidget'\nimport { createLogger } from '../../../utils/logger'\nimport { document, window } from '../../../utils/globals'\nimport { formDataToQuery } from '../../../utils/request-utils'\n\nconst logger = createLogger('[ConversationsManager]')\n\nconst WIDGET_CONTAINER_ID = 'ph-conversations-widget-container'\nconst POLL_INTERVAL_MS = 5000 // 5 seconds\n\nexport class ConversationsManager implements ConversationsManagerInterface {\n    private _config: ConversationsRemoteConfig\n    private _persistence: ConversationsPersistence\n    private _widgetRef: ConversationsWidget | null = null\n    private _containerElement: HTMLDivElement | null = null\n    private _currentTicketId: string | null = null\n    private _pollIntervalId: number | null = null\n    private _lastMessageTimestamp: string | null = null\n    private _isPolling: boolean = false\n    private _unsubscribeIdentifyListener: (() => void) | null = null\n    private _unreadCount: number = 0\n    // SECURITY: widget_session_id is the key for access control\n    // This is a random UUID that only this browser knows\n    private _widgetSessionId: string\n\n    constructor(\n        config: ConversationsRemoteConfig,\n        private readonly _posthog: PostHog\n    ) {\n        this._config = config\n        this._persistence = new ConversationsPersistence(_posthog)\n        // Get or create widget_session_id - this stays the same even when user identifies\n        this._widgetSessionId = this._persistence.getOrCreateWidgetSessionId()\n\n        logger.info('ConversationsManager initialized', {\n            config,\n            widgetSessionId: this._widgetSessionId,\n        })\n\n        this._initialize()\n    }\n\n    /** Send a message via the API */\n    private _apiSendMessage(\n        message: string,\n        ticketId: string | undefined,\n        userTraits?: UserProvidedTraits\n    ): Promise<SendMessageResponse> {\n        const token = this._config.token\n\n        // eslint-disable-next-line compat/compat\n        return new Promise((resolve, reject) => {\n            const distinctId = this._posthog.get_distinct_id()\n            const personProperties = this._posthog.persistence?.props || {}\n\n            // Priority for traits:\n            // 1. User-provided traits from the widget form\n            // 2. PostHog person properties\n            const name = userTraits?.name || personProperties.$name || personProperties.name || null\n            const email = userTraits?.email || personProperties.$email || personProperties.email || null\n\n            const payload = {\n                widget_session_id: this._widgetSessionId,\n                // distinct_id is only used for Person linking, not access control\n                distinct_id: distinctId,\n                message: message.trim(),\n                traits: {\n                    name,\n                    email,\n                },\n                ticket_id: ticketId || null,\n            }\n\n            this._posthog._send_request({\n                url: this._posthog.requestRouter.endpointFor('api', '/api/conversations/v1/widget/message'),\n                method: 'POST',\n                data: payload,\n                headers: {\n                    'X-Conversations-Token': token,\n                },\n                callback: (response) => {\n                    if (response.statusCode === 429) {\n                        reject(new Error('Too many requests. Please wait before trying again.'))\n                        return\n                    }\n\n                    if (response.statusCode !== 200 && response.statusCode !== 201) {\n                        const errorMsg = response.json?.detail || response.json?.message || 'Failed to send message'\n                        logger.error('Failed to send message', { status: response.statusCode })\n                        reject(new Error(errorMsg))\n                        return\n                    }\n\n                    if (!response.json) {\n                        reject(new Error('Invalid response from server'))\n                        return\n                    }\n\n                    const data = response.json as SendMessageResponse\n                    resolve(data)\n                },\n            })\n        })\n    }\n\n    /** Fetch messages via the API */\n    private _apiGetMessages(ticketId: string, after?: string): Promise<GetMessagesResponse> {\n        const token = this._config.token\n\n        // eslint-disable-next-line compat/compat\n        return new Promise((resolve, reject) => {\n            // SECURITY: widget_session_id is required for access control\n            // distinct_id is NOT sent for getMessages - access is controlled by widget_session_id only\n            const queryParams: Record<string, string> = {\n                widget_session_id: this._widgetSessionId,\n                limit: '50',\n            }\n\n            if (after) {\n                queryParams.after = after\n            }\n\n            this._posthog._send_request({\n                url: this._posthog.requestRouter.endpointFor(\n                    'api',\n                    `/api/conversations/v1/widget/messages/${ticketId}?${formDataToQuery(queryParams)}`\n                ),\n                method: 'GET',\n                headers: {\n                    'X-Conversations-Token': token,\n                },\n                callback: (response) => {\n                    if (response.statusCode === 429) {\n                        reject(new Error('Too many requests. Please wait before trying again.'))\n                        return\n                    }\n\n                    if (response.statusCode !== 200) {\n                        const errorMsg = response.json?.detail || response.json?.message || 'Failed to fetch messages'\n                        logger.error('Failed to fetch messages', { status: response.statusCode })\n                        reject(new Error(errorMsg))\n                        return\n                    }\n\n                    if (!response.json) {\n                        reject(new Error('Invalid response from server'))\n                        return\n                    }\n\n                    const data = response.json as GetMessagesResponse\n                    resolve(data)\n                },\n            })\n        })\n    }\n\n    /** Mark messages as read via the API */\n    private _apiMarkAsRead(ticketId: string): Promise<MarkAsReadResponse> {\n        const token = this._config.token\n\n        // eslint-disable-next-line compat/compat\n        return new Promise((resolve, reject) => {\n            logger.info('Marking messages as read', { ticketId })\n\n            this._posthog._send_request({\n                url: this._posthog.requestRouter.endpointFor(\n                    'api',\n                    `/api/conversations/v1/widget/messages/${ticketId}/read`\n                ),\n                method: 'POST',\n                data: {\n                    widget_session_id: this._widgetSessionId,\n                },\n                headers: {\n                    'X-Conversations-Token': token,\n                },\n                callback: (response) => {\n                    if (response.statusCode === 429) {\n                        reject(new Error('Too many requests. Please wait before trying again.'))\n                        return\n                    }\n\n                    if (response.statusCode !== 200) {\n                        const errorMsg =\n                            response.json?.detail || response.json?.message || 'Failed to mark messages as read'\n                        logger.error('Failed to mark messages as read', { status: response.statusCode })\n                        reject(new Error(errorMsg))\n                        return\n                    }\n\n                    if (!response.json) {\n                        reject(new Error('Invalid response from server'))\n                        return\n                    }\n\n                    const data = response.json as MarkAsReadResponse\n                    resolve(data)\n                },\n            })\n        })\n    }\n\n    /**\n     * Initialize the widget\n     */\n    private _initialize(): void {\n        if (!document || !window) {\n            logger.info('Conversations not available: Document or window not available')\n            return\n        }\n\n        // Load any existing ticket ID from localStorage\n        this._currentTicketId = this._persistence.loadTicketId()\n        logger.info('Loaded ticket ID from storage', { ticketId: this._currentTicketId })\n\n        const savedState = this._persistence.loadWidgetState()\n        let initialState: ConversationsWidgetState = 'closed'\n        if (savedState === 'open') {\n            initialState = 'open'\n        }\n\n        // Get initial user traits (from PostHog person properties or saved)\n        const initialUserTraits = this._getInitialUserTraits()\n\n        // Render the widget\n        this._renderWidget(initialState, initialUserTraits)\n\n        // Track widget initialization\n        this._posthog.capture('$conversations_widget_loaded', {\n            hasExistingTicket: !!this._currentTicketId,\n            initialState: initialState,\n            hasUserTraits: !!initialUserTraits,\n        })\n\n        // If we have a ticket, load its messages\n        if (this._currentTicketId) {\n            this._loadMessages()\n        }\n\n        // Start polling for messages (always, to show unread badge)\n        this._startPolling()\n\n        // Listen for identify events to handle distinct_id changes\n        this._setupIdentifyListener()\n    }\n\n    /**\n     * Get initial user traits from PostHog or localStorage\n     */\n    private _getInitialUserTraits(): UserProvidedTraits | null {\n        // First, check PostHog's person properties\n        const personProperties = this._posthog.persistence?.props || {}\n        const posthogName = personProperties.$name || personProperties.name\n        const posthogEmail = personProperties.$email || personProperties.email\n\n        // If we have traits from PostHog, use those\n        if (posthogName || posthogEmail) {\n            return {\n                name: posthogName || undefined,\n                email: posthogEmail || undefined,\n            }\n        }\n\n        // Otherwise, check localStorage for previously saved traits\n        const savedTraits = this._persistence.loadUserTraits()\n        if (savedTraits && (savedTraits.name || savedTraits.email)) {\n            return savedTraits\n        }\n\n        return null\n    }\n\n    /**\n     * Handle user identification from the widget form\n     */\n    private _handleIdentify = (traits: UserProvidedTraits): void => {\n        // Save traits to localStorage\n        this._persistence.saveUserTraits(traits)\n\n        // Track identification\n        this._posthog.capture('$conversations_user_identified', {\n            hasName: !!traits.name,\n            hasEmail: !!traits.email,\n        })\n    }\n\n    /**\n     * Handle sending a message\n     */\n    private _handleSendMessage = async (message: string): Promise<void> => {\n        // Get user traits from the widget\n        const userTraits = this._widgetRef?.getUserTraits() || undefined\n\n        const isNewTicket = !this._currentTicketId\n\n        try {\n            // Call API directly\n            const response = await this._apiSendMessage(message, this._currentTicketId || undefined, userTraits)\n\n            // Update current ticket ID\n            if (!this._currentTicketId) {\n                this._currentTicketId = response.ticket_id\n                this._persistence.saveTicketId(response.ticket_id)\n                logger.info('New ticket created', { ticketId: response.ticket_id })\n            }\n\n            // Track message sent\n            this._posthog.capture('$conversations_message_sent', {\n                ticketId: response.ticket_id,\n                isNewTicket: isNewTicket,\n                messageLength: message.length,\n            })\n\n            // Update last message timestamp\n            this._lastMessageTimestamp = response.created_at\n\n            // Poll for response immediately\n            setTimeout(() => this._pollMessages(), 1000)\n        } catch (error) {\n            logger.error('Failed to send message', error)\n            throw error\n        }\n    }\n\n    /**\n     * Handle widget state changes\n     */\n    private _handleStateChange = (state: ConversationsWidgetState): void => {\n        logger.info('Widget state changed', { state })\n\n        // Track state changes\n        this._posthog.capture('$conversations_widget_state_changed', {\n            state: state,\n            ticketId: this._currentTicketId,\n        })\n\n        // Save state to localStorage\n        this._persistence.saveWidgetState(state)\n\n        // Mark messages as read when widget opens\n        if (state === 'open') {\n            if (this._unreadCount > 0 && this._currentTicketId) {\n                this._markMessagesAsRead()\n            }\n        }\n    }\n\n    /**\n     * Mark messages as read\n     */\n    private async _markMessagesAsRead(): Promise<void> {\n        if (!this._currentTicketId) {\n            return\n        }\n\n        try {\n            const response = await this._apiMarkAsRead(this._currentTicketId)\n            this._unreadCount = response.unread_count\n            // Update the widget to reflect the new unread count\n            this._widgetRef?.setUnreadCount(0)\n            logger.info('Messages marked as read', { unreadCount: response.unread_count })\n        } catch (error) {\n            logger.error('Failed to mark messages as read', error)\n        }\n    }\n\n    /**\n     * Load messages for the current ticket\n     */\n    private async _loadMessages(): Promise<void> {\n        if (!this._currentTicketId) {\n            return\n        }\n\n        try {\n            const response = await this._apiGetMessages(this._currentTicketId, this._lastMessageTimestamp || undefined)\n\n            // Update unread count from response\n            if (isNumber(response.unread_count)) {\n                this._unreadCount = response.unread_count\n                this._widgetRef?.setUnreadCount(response.unread_count)\n\n                // If widget is open and there are unread messages, mark them as read\n                if (response.unread_count > 0 && this._isWidgetOpen()) {\n                    this._markMessagesAsRead()\n                }\n            }\n\n            if (response.messages.length > 0) {\n                this._widgetRef?.addMessages(response.messages)\n                // Update last message timestamp\n                const lastMessage = response.messages[response.messages.length - 1]\n                this._lastMessageTimestamp = lastMessage.created_at\n            }\n        } catch (error) {\n            logger.error('Failed to load messages', error)\n        }\n    }\n\n    /**\n     * Check if the widget is currently open\n     */\n    private _isWidgetOpen(): boolean {\n        return this._persistence.loadWidgetState() === 'open'\n    }\n\n    /**\n     * Poll for new messages\n     */\n    private _pollMessages = async (): Promise<void> => {\n        if (this._isPolling || !this._currentTicketId) {\n            return\n        }\n\n        this._isPolling = true\n        try {\n            await this._loadMessages()\n        } finally {\n            this._isPolling = false\n        }\n    }\n\n    /**\n     * Start polling for new messages\n     */\n    private _startPolling(): void {\n        if (this._pollIntervalId) {\n            return // Already polling\n        }\n\n        // Poll immediately\n        this._pollMessages()\n\n        // Set up interval\n        this._pollIntervalId = window?.setInterval(() => {\n            this._pollMessages()\n        }, POLL_INTERVAL_MS) as unknown as number\n\n        logger.info('Started polling for messages')\n    }\n\n    /**\n     * Stop polling for new messages\n     */\n    private _stopPolling(): void {\n        if (this._pollIntervalId) {\n            window?.clearInterval(this._pollIntervalId)\n            this._pollIntervalId = null\n            logger.info('Stopped polling for messages')\n        }\n    }\n\n    /**\n     * Setup listener for identify events to handle distinct_id changes\n     */\n    private _setupIdentifyListener(): void {\n        // Listen for captured events and detect $identify events\n        this._unsubscribeIdentifyListener = this._posthog.on('eventCaptured', (event: any) => {\n            if (event.event === '$identify') {\n                const newDistinctId = event.properties?.distinct_id\n                const oldDistinctId = event.properties?.$anon_distinct_id\n\n                if (oldDistinctId && newDistinctId && oldDistinctId !== newDistinctId) {\n                    logger.info('Detected identify event', { oldDistinctId, newDistinctId })\n                    this._handleDistinctIdChange(oldDistinctId, newDistinctId)\n                }\n            }\n        })\n    }\n\n    /**\n     * Handle distinct_id changes when user identifies.\n     * The user continues their conversation seamlessly - widget_session_id stays the same.\n     * No migration needed since tickets are keyed by widget_session_id, not distinct_id.\n     * Backend will update ticket.distinct_id for Person linking on the next message.\n     */\n    private _handleDistinctIdChange(oldDistinctId: string, newDistinctId: string): void {\n        // No migration needed - widget_session_id stays the same\n        // The user keeps access to their ticket because the widget_session_id hasn't changed\n        logger.info('User identified, conversation continues with same widget_session_id', {\n            ticketId: this._currentTicketId,\n            widgetSessionId: this._widgetSessionId,\n            oldDistinctId,\n            newDistinctId,\n        })\n\n        // Track the identity change\n        this._posthog.capture('$conversations_identity_changed', {\n            hadExistingTicket: !!this._currentTicketId,\n        })\n    }\n\n    /**\n     * Enable/show the widget (button and chat panel)\n     */\n    enable(): void {\n        this._widgetRef?.show()\n    }\n\n    /**\n     * Disable/hide the widget completely (button and chat panel)\n     */\n    disable(): void {\n        this._widgetRef?.hide()\n    }\n\n    /**\n     * Send a message programmatically (internal use)\n     */\n    sendMessage(message: string): void {\n        this._handleSendMessage(message)\n    }\n\n    /**\n     * Clean up the widget\n     */\n    destroy(): void {\n        this._stopPolling()\n\n        // Unsubscribe from identify events\n        if (this._unsubscribeIdentifyListener) {\n            this._unsubscribeIdentifyListener()\n            this._unsubscribeIdentifyListener = null\n        }\n\n        if (this._containerElement) {\n            render(null, this._containerElement)\n            this._containerElement.remove()\n            this._containerElement = null\n        }\n\n        this._widgetRef = null\n        logger.info('Widget destroyed')\n    }\n\n    /**\n     * Reset all conversation data and destroy the widget.\n     * Called on posthog.reset() to start fresh.\n     */\n    reset(): void {\n        // Clear all persisted conversation data\n        this._persistence.clearAll()\n\n        // Reset local state\n        this._currentTicketId = null\n        this._lastMessageTimestamp = null\n        this._unreadCount = 0\n\n        // Destroy the widget\n        this.destroy()\n\n        logger.info('Conversations reset')\n    }\n\n    /**\n     * Render the widget to the DOM\n     */\n    private _renderWidget(initialState: ConversationsWidgetState, initialUserTraits: UserProvidedTraits | null): void {\n        if (!document) {\n            logger.info('Conversations widget not rendered: Document not available')\n            return\n        }\n\n        // Create container if it doesn't exist\n        let container = document.getElementById(WIDGET_CONTAINER_ID) as HTMLDivElement\n        if (!container) {\n            if (!document.body) {\n                logger.info('Conversations widget not rendered: Document body not available yet')\n                return\n            }\n            container = document.createElement('div')\n            container.id = WIDGET_CONTAINER_ID\n            document.body.appendChild(container)\n        }\n        this._containerElement = container\n\n        // Render widget with ref\n        render(\n            <ConversationsWidget\n                ref={(ref: ConversationsWidget | null) => {\n                    this._widgetRef = ref\n                }}\n                config={this._config}\n                initialState={initialState}\n                initialUserTraits={initialUserTraits}\n                onSendMessage={this._handleSendMessage}\n                onStateChange={this._handleStateChange}\n                onIdentify={this._handleIdentify}\n            />,\n            container\n        )\n    }\n}\n\n/**\n * Initialize the conversations widget\n * This is the entry point called from the lazy-loaded bundle\n */\nexport function initConversations(config: ConversationsRemoteConfig, posthog: PostHog): ConversationsManager {\n    logger.info('initConversations called', { hasConfig: !!config, hasPosthog: !!posthog })\n    return new ConversationsManager(config, posthog)\n}\n","import { initConversations } from '../extensions/conversations/external'\nimport { assignableWindow } from '../utils/globals'\n\nassignableWindow.__PosthogExtensions__ = assignableWindow.__PosthogExtensions__ || {}\nassignableWindow.__PosthogExtensions__.initConversations = initConversations\n\nexport default initConversations\n"],"names":["c","s","a","nativeIsArray","Array","isArray","ObjProto","Object","prototype","type_utils_hasOwnProperty","hasOwnProperty","type_utils_toString","toString","obj","call","isUndefined","x","isNumber","win","window","undefined","global","globalThis","self","File","nativeForEach","forEach","navigator","document","location","fetch","XMLHttpRequest","AbortController","userAgent","assignableWindow","_createLogger","prefix","_temp","debugEnabled","logger","_log","level","POSTHOG_DEBUG","console","consoleLog","_len","arguments","length","args","_key","info","_len2","_key2","warn","_len3","_key3","error","_len4","_key4","critical","_len5","_key5","uninitializedWarning","methodName","createLogger","additionalPrefix","options","Math","trunc","v","ceil","floor","Number","isInteger","value","isFinite","DIGITS","UUID","constructor","bytes","this","TypeError","fromFieldsV7","unixTsMs","randA","randBHi","randBLo","RangeError","Uint8Array","pow","text","i","charAt","Error","clone","slice","equals","other","compareTo","diff","sign","V7Generator","_timestamp","_counter","_random","DefaultRandom","generate","generateOrAbort","valueAfterReset","ts","Date","now","_resetCounter","nextUint32","defaultGenerator","getRandomValues","buffer","UUIDV7_DENY_WEAK_RNG","random","crypto","_buffer","Uint32Array","_cursor","Infinity","uuidv7","uuidv7obj","CONVERSATIONS_WIDGET_SESSION_ID","CONVERSATIONS_TICKET_ID","CONVERSATIONS_WIDGET_STATE","CONVERSATIONS_USER_TRAITS","ConversationsPersistence","_posthog","_cachedWidgetSessionId","_isPersistenceAvailable","_this$_posthog$persis","_this$_posthog$persis2","persistence","isDisabled","getOrCreateWidgetSessionId","sessionId","_this$_posthog$persis3","_this$_posthog$persis4","get_property","register","clearWidgetSessionId","_this$_posthog$persis5","unregister","saveTicketId","ticketId","_this$_posthog$persis6","loadTicketId","_this$_posthog$persis7","clearTicketId","_this$_posthog$persis8","saveWidgetState","state","_this$_posthog$persis9","loadWidgetState","_this$_posthog$persis0","saveUserTraits","traits","_this$_posthog$persis1","hasName","name","hasEmail","email","loadUserTraits","_this$_posthog$persis10","clearUserTraits","_this$_posthog$persis11","clearAll","_this$_posthog$persis12","_this$_posthog$persis13","_this$_posthog$persis14","getStyles","primaryColor","widget","position","bottom","right","zIndex","fontFamily","buttonContainer","button","width","height","borderRadius","background","color","border","cursor","boxShadow","display","alignItems","justifyContent","transition","unreadBadge","top","minWidth","fontSize","fontWeight","padding","boxSizing","flexDirection","overflow","windowOpen","maxHeight","header","flexShrink","headerTitle","headerActions","gap","headerButton","lineHeight","opacity","messages","flex","overflowY","message","maxWidth","animation","messageCustomer","alignSelf","messageAgent","messageAuthor","marginBottom","messageContent","wordWrap","whiteSpace","messageContentCustomer","borderBottomRightRadius","messageContentAgent","borderBottomLeftRadius","messageTime","marginTop","typing","typingDot","borderTop","borderBottom","textAlign","inputContainer","input","resize","outline","fieldSizing","sendButton","identificationForm","formTitle","formDescription","formField","formLabel","formInput","formInputError","borderColor","formError","formSubmitButton","formOptional","OpenChatButton","_ref","handleToggleOpen","unreadCount","styles","displayCount","_jsx","style","children","_jsxs","onClick","onMouseEnter","e","currentTarget","transform","onMouseLeave","viewBox","fill","xmlns","d","SendMessageButton","inputValue","isLoading","handleSendMessage","_extends","trim","disabled","stroke","strokeWidth","strokeLinejoin","CloseChatButton","handleClose","ConversationsWidget","Component","props","_this","super","_messagesEndRef","_inputRef","_handleToggleOpen","setState","prevState","_handleClose","_handleInputChange","target","_handleKeyPress","key","shiftKey","preventDefault","_handleSendMessage","_handleFormNameChange","formName","_handleFormEmailChange","formEmail","formEmailError","_handleFormSubmit","config","onIdentify","requireEmail","_validateEmail","userTraits","showIdentificationForm","_asyncToGenerator","trimmedMessage","userMessage","id","content","author_type","author_name","created_at","toISOString","is_private","onSendMessage","filter","m","initialUserTraits","needsIdentification","_needsIdentification","initialState","componentDidMount","greetingText","_addGreetingMessage","componentDidUpdate","_prevProps","_scrollToBottom","onStateChange","_focusInput","greetingMessage","scrollIntoView","behavior","focus","test","_formatTime","isoString","date","diffMs","getTime","diffMins","toLocaleDateString","addMessages","existingIds","Set","map","newMessages","has","show","hide","close","getUserTraits","setUnreadCount","count","_renderIdentificationForm","title","identificationFormTitle","description","identificationFormDescription","showNameField","collectName","onSubmit","type","onInput","placeholder","autoComplete","_renderMessage","isCustomer","messageStyle","contentStyle","render","placeholderText","windowStyle","_Fragment","animationDelay","ref","el","onKeyPress","rows","breaker","each","iterator","thisArg","isNull","isNullish","l","eachArray","FormData","isFormData","pair","entries","formDataToQuery","formdata","arg_separator","use_val","use_key","tph_arr","val","encodeURIComponent","isFile","join","WIDGET_CONTAINER_ID","ConversationsManager","_widgetRef","_containerElement","_currentTicketId","_pollIntervalId","_lastMessageTimestamp","_isPolling","_unsubscribeIdentifyListener","_unreadCount","_handleIdentify","_persistence","capture","_this$_widgetRef","isNewTicket","response","_apiSendMessage","ticket_id","messageLength","setTimeout","_pollMessages","_x","apply","_handleStateChange","_markMessagesAsRead","_loadMessages","_config","_widgetSessionId","widgetSessionId","_initialize","token","Promise","resolve","reject","distinctId","get_distinct_id","personProperties","$name","$email","payload","widget_session_id","distinct_id","_send_request","url","requestRouter","endpointFor","method","data","headers","callback","statusCode","_response$json","_response$json2","errorMsg","json","detail","status","_apiGetMessages","after","queryParams","limit","_response$json3","_response$json4","_apiMarkAsRead","_response$json5","_response$json6","_getInitialUserTraits","_renderWidget","hasExistingTicket","hasUserTraits","_startPolling","_setupIdentifyListener","posthogName","posthogEmail","savedTraits","_this2","_this2$_widgetRef","unread_count","_this3","_this3$_widgetRef","_isWidgetOpen","_this3$_widgetRef2","lastMessage","setInterval","_stopPolling","clearInterval","on","event","_event$properties","_event$properties2","newDistinctId","properties","oldDistinctId","$anon_distinct_id","_handleDistinctIdChange","hadExistingTicket","enable","_this$_widgetRef2","disable","_this$_widgetRef3","sendMessage","destroy","remove","reset","container","getElementById","body","createElement","appendChild","initConversations","posthog","hasConfig","hasPosthog","__PosthogExtensions__"],"mappings":"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","x_google_ignoreList":[0]}