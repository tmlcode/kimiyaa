{"version":3,"file":"persistence.js","sourceRoot":"","sources":["../../../../../src/extensions/conversations/external/persistence.ts"],"names":[],"mappings":"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","sourcesContent":["import { PostHog } from '../../../posthog-core'\nimport { UserProvidedTraits } from '../../../posthog-conversations-types'\nimport { createLogger } from '../../../utils/logger'\nimport { uuidv7 } from '../../../uuidv7'\n\nconst logger = createLogger('[ConversationsPersistence]')\n\n// Persistence keys - defined here in the lazy-loaded extension bundle\n// These keys are also listed in constants.ts PERSISTENCE_RESERVED_PROPERTIES\n// to prevent them from being included in event properties\nconst CONVERSATIONS_WIDGET_SESSION_ID = '$conversations_widget_session_id'\nconst CONVERSATIONS_TICKET_ID = '$conversations_ticket_id'\nconst CONVERSATIONS_WIDGET_STATE = '$conversations_widget_state'\nconst CONVERSATIONS_USER_TRAITS = '$conversations_user_traits'\n\n/**\n * ConversationsPersistence manages conversation-related data using PostHog's\n * core persistence layer. This ensures the data respects user's persistence\n * preferences (localStorage, cookie, sessionStorage, memory) and consent settings.\n */\nexport class ConversationsPersistence {\n    private _cachedWidgetSessionId: string | null = null\n\n    constructor(private readonly _posthog: PostHog) {}\n\n    /** Check if persistence is available and enabled */\n    private _isPersistenceAvailable(): boolean {\n        return !!this._posthog.persistence && !this._posthog.persistence.isDisabled?.()\n    }\n\n    /**\n     * Get or create the widget session ID (random UUID for access control).\n     * This ID is generated once per browser and persists across sessions.\n     * It is NOT tied to distinct_id - it stays the same even when user identifies.\n     *\n     * SECURITY: This is the key for access control. Only the browser that created\n     * the widget_session_id can access tickets associated with it.\n     */\n    getOrCreateWidgetSessionId(): string {\n        // Return cached value if available\n        if (this._cachedWidgetSessionId) {\n            return this._cachedWidgetSessionId\n        }\n\n        // Check if persistence is available\n        if (!this._isPersistenceAvailable()) {\n            // Fallback: generate a new one each time (won't persist)\n            // This is acceptable for SSR or environments without persistence\n            const sessionId = uuidv7()\n            logger.warn('Persistence not available, widget_session_id will not persist', { sessionId })\n            return sessionId\n        }\n\n        try {\n            let sessionId = this._posthog.persistence?.get_property(CONVERSATIONS_WIDGET_SESSION_ID)\n            if (!sessionId) {\n                sessionId = uuidv7()\n                this._posthog.persistence?.register({ [CONVERSATIONS_WIDGET_SESSION_ID]: sessionId })\n            }\n            this._cachedWidgetSessionId = sessionId\n            return sessionId\n        } catch (error) {\n            logger.error('Failed to get/create widget_session_id', error)\n            // Fallback: generate a new one (won't persist)\n            return uuidv7()\n        }\n    }\n\n    /**\n     * Clear the widget session ID (called on posthog.reset()).\n     * This will create a new session and lose access to previous tickets.\n     */\n    clearWidgetSessionId(): void {\n        this._cachedWidgetSessionId = null\n\n        if (!this._isPersistenceAvailable()) {\n            return\n        }\n\n        try {\n            this._posthog.persistence?.unregister(CONVERSATIONS_WIDGET_SESSION_ID)\n            logger.info('Cleared widget_session_id')\n        } catch (error) {\n            logger.error('Failed to clear widget_session_id', error)\n        }\n    }\n\n    /**\n     * Save the current ticket ID to persistence\n     */\n    saveTicketId(ticketId: string): void {\n        if (!this._isPersistenceAvailable()) {\n            logger.warn('Persistence not available')\n            return\n        }\n\n        try {\n            this._posthog.persistence?.register({ [CONVERSATIONS_TICKET_ID]: ticketId })\n            logger.info('Saved ticket ID', { ticketId })\n        } catch (error) {\n            logger.error('Failed to save ticket ID', error)\n        }\n    }\n\n    /**\n     * Load the current ticket ID from persistence\n     */\n    loadTicketId(): string | null {\n        if (!this._isPersistenceAvailable()) {\n            logger.warn('Persistence not available')\n            return null\n        }\n\n        try {\n            const ticketId = this._posthog.persistence?.get_property(CONVERSATIONS_TICKET_ID)\n            if (ticketId) {\n                logger.info('Loaded ticket ID', { ticketId })\n            }\n            return ticketId || null\n        } catch (error) {\n            logger.error('Failed to load ticket ID', error)\n            return null\n        }\n    }\n\n    /**\n     * Clear the current ticket ID from persistence\n     */\n    clearTicketId(): void {\n        if (!this._isPersistenceAvailable()) {\n            logger.warn('Persistence not available')\n            return\n        }\n\n        try {\n            this._posthog.persistence?.unregister(CONVERSATIONS_TICKET_ID)\n            logger.info('Cleared ticket ID')\n        } catch (error) {\n            logger.error('Failed to clear ticket ID', error)\n        }\n    }\n\n    /**\n     * Save widget state (open, closed)\n     */\n    saveWidgetState(state: 'open' | 'closed'): void {\n        if (!this._isPersistenceAvailable()) {\n            return\n        }\n\n        try {\n            this._posthog.persistence?.register({ [CONVERSATIONS_WIDGET_STATE]: state })\n        } catch (error) {\n            logger.error('Failed to save widget state', error)\n        }\n    }\n\n    /**\n     * Load widget state\n     */\n    loadWidgetState(): 'open' | 'closed' | null {\n        if (!this._isPersistenceAvailable()) {\n            return null\n        }\n\n        try {\n            const state = this._posthog.persistence?.get_property(CONVERSATIONS_WIDGET_STATE)\n            if (state === 'open' || state === 'closed') {\n                return state\n            }\n            return null\n        } catch (error) {\n            logger.error('Failed to load widget state', error)\n            return null\n        }\n    }\n\n    /**\n     * Save user-provided traits (name, email) to persistence\n     */\n    saveUserTraits(traits: UserProvidedTraits): void {\n        if (!this._isPersistenceAvailable()) {\n            logger.warn('Persistence not available')\n            return\n        }\n\n        try {\n            this._posthog.persistence?.register({ [CONVERSATIONS_USER_TRAITS]: traits })\n            logger.info('Saved user traits', { hasName: !!traits.name, hasEmail: !!traits.email })\n        } catch (error) {\n            logger.error('Failed to save user traits', error)\n        }\n    }\n\n    /**\n     * Load user-provided traits from persistence\n     */\n    loadUserTraits(): UserProvidedTraits | null {\n        if (!this._isPersistenceAvailable()) {\n            return null\n        }\n\n        try {\n            const traits = this._posthog.persistence?.get_property(CONVERSATIONS_USER_TRAITS) as\n                | UserProvidedTraits\n                | undefined\n            if (traits) {\n                logger.info('Loaded user traits', { hasName: !!traits.name, hasEmail: !!traits.email })\n                return traits\n            }\n            return null\n        } catch (error) {\n            logger.error('Failed to load user traits', error)\n            return null\n        }\n    }\n\n    /**\n     * Clear user-provided traits from persistence\n     */\n    clearUserTraits(): void {\n        if (!this._isPersistenceAvailable()) {\n            return\n        }\n\n        try {\n            this._posthog.persistence?.unregister(CONVERSATIONS_USER_TRAITS)\n            logger.info('Cleared user traits')\n        } catch (error) {\n            logger.error('Failed to clear user traits', error)\n        }\n    }\n\n    /**\n     * Clear all conversation-related data from persistence.\n     * This is called on posthog.reset() to start fresh.\n     */\n    clearAll(): void {\n        if (!this._isPersistenceAvailable()) {\n            return\n        }\n\n        try {\n            // Clear all conversation properties\n            this._posthog.persistence?.unregister(CONVERSATIONS_WIDGET_STATE)\n            this._posthog.persistence?.unregister(CONVERSATIONS_USER_TRAITS)\n            this._posthog.persistence?.unregister(CONVERSATIONS_TICKET_ID)\n\n            // Clear widget session ID last (this will lose access to previous tickets)\n            this.clearWidgetSessionId()\n\n            logger.info('Cleared all conversation data')\n        } catch (error) {\n            logger.error('Failed to clear conversation data', error)\n        }\n    }\n}\n"]}