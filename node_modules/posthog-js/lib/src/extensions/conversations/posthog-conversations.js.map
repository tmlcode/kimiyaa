{"version":3,"file":"posthog-conversations.js","sourceRoot":"","sources":["../../../../src/extensions/conversations/posthog-conversations.ts"],"names":[],"mappings":"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","sourcesContent":["import { PostHog } from '../../posthog-core'\nimport { ConversationsRemoteConfig } from '../../posthog-conversations-types'\nimport { RemoteConfig } from '../../types'\nimport { assignableWindow, LazyLoadedConversationsInterface, window as _window } from '../../utils/globals'\nimport { createLogger } from '../../utils/logger'\nimport { isNullish, isUndefined, isBoolean, isNull } from '@posthog/core'\n\nconst logger = createLogger('[Conversations]')\n\n/**\n * Extract hostname from a domain string (handles URLs and plain hostnames)\n */\nfunction extractHostname(domain: string): string | null {\n    // Remove protocol if present\n    let hostname = domain.replace(/^https?:\\/\\//, '')\n    // Remove path, query, port if present\n    hostname = hostname.split('/')[0].split('?')[0].split(':')[0]\n    return hostname || null\n}\n\n/**\n * Check if the current domain matches the allowed domains list.\n * Returns true if:\n * - domains is empty or not present (no restriction)\n * - current hostname matches any allowed domain\n */\nfunction isCurrentDomainAllowed(domains: string[] | undefined): boolean {\n    // No domain restriction - allow all\n    if (!domains || domains.length === 0) {\n        return true\n    }\n\n    const currentHostname = _window?.location?.hostname\n    if (!currentHostname) {\n        // Can't determine hostname (SSR, etc.) - allow by default\n        return true\n    }\n\n    return domains.some((domain) => {\n        const allowedHostname = extractHostname(domain)\n        if (!allowedHostname) {\n            return false\n        }\n\n        if (allowedHostname.startsWith('*.')) {\n            // Wildcard match: *.example.com matches foo.example.com and example.com\n            const pattern = allowedHostname.slice(2) // Remove \"*.\"\n            return currentHostname.endsWith(`.${pattern}`) || currentHostname === pattern\n        }\n\n        // Exact match\n        return currentHostname === allowedHostname\n    })\n}\n\nexport type ConversationsManager = LazyLoadedConversationsInterface\n\nexport class PostHogConversations {\n    // This is set to undefined until the remote config is loaded\n    // then it's set to true if conversations are enabled\n    // or false if conversations are disabled in the project settings\n    private _isConversationsEnabled?: boolean = undefined\n    private _conversationsManager: LazyLoadedConversationsInterface | null = null\n    private _isInitializing: boolean = false\n    private _remoteConfig: ConversationsRemoteConfig | null = null\n\n    constructor(private _instance: PostHog) {}\n\n    onRemoteConfig(response: RemoteConfig) {\n        // Don't load conversations if disabled via config\n        if (this._instance.config.disable_conversations) {\n            return\n        }\n\n        const conversations = response['conversations']\n        if (isNullish(conversations)) {\n            return\n        }\n\n        // Handle both boolean and object response\n        if (isBoolean(conversations)) {\n            this._isConversationsEnabled = conversations\n        } else {\n            // It's a ConversationsRemoteConfig object\n            this._isConversationsEnabled = conversations.enabled\n            this._remoteConfig = conversations\n        }\n\n        this.loadIfEnabled()\n    }\n\n    reset(): void {\n        // Delegate cleanup to the lazy-loaded manager (which knows about persistence keys)\n        // If not loaded, there's nothing to reset anyway\n        this._conversationsManager?.reset()\n        this._conversationsManager = null\n\n        // Reset local state\n        this._isConversationsEnabled = undefined\n        this._remoteConfig = null\n    }\n\n    loadIfEnabled() {\n        if (this._conversationsManager) {\n            return\n        }\n        if (this._isInitializing) {\n            return\n        }\n        if (this._instance.config.disable_conversations) {\n            return\n        }\n        if (this._instance.config.cookieless_mode && this._instance.consent.isOptedOut()) {\n            return\n        }\n\n        const phExtensions = assignableWindow?.__PosthogExtensions__\n        if (!phExtensions) {\n            return\n        }\n\n        // Wait for remote config to load\n        if (isUndefined(this._isConversationsEnabled)) {\n            return\n        }\n\n        // Check if conversations are enabled\n        if (!this._isConversationsEnabled) {\n            return\n        }\n\n        // Check if we have the required config\n        if (!this._remoteConfig || !this._remoteConfig.token) {\n            logger.error('Conversations enabled but missing token in remote config.')\n            return\n        }\n\n        // Check if current domain is allowed\n        if (!isCurrentDomainAllowed(this._remoteConfig.domains)) {\n            return\n        }\n\n        this._isInitializing = true\n\n        try {\n            const initConversations = phExtensions.initConversations\n            if (initConversations) {\n                // Conversations code is already loaded\n                this._completeInitialization(initConversations)\n                this._isInitializing = false\n                return\n            }\n\n            // If we reach here, conversations code is not loaded yet\n            const loadExternalDependency = phExtensions.loadExternalDependency\n            if (!loadExternalDependency) {\n                this._handleLoadError('PostHog loadExternalDependency extension not found.')\n                return\n            }\n\n            // Load the conversations bundle\n            loadExternalDependency(this._instance, 'conversations', (err) => {\n                if (err || !phExtensions.initConversations) {\n                    this._handleLoadError('Could not load conversations script', err)\n                } else {\n                    this._completeInitialization(phExtensions.initConversations)\n                }\n                this._isInitializing = false\n            })\n        } catch (e) {\n            this._handleLoadError('Error initializing conversations', e)\n            this._isInitializing = false\n        }\n    }\n\n    /** Helper to finalize conversations initialization */\n    private _completeInitialization(\n        initConversationsFn: (config: ConversationsRemoteConfig, posthog: PostHog) => LazyLoadedConversationsInterface\n    ): void {\n        if (!this._remoteConfig) {\n            logger.error('Cannot complete initialization: remote config is null')\n            return\n        }\n\n        try {\n            // Pass config and PostHog instance to the extension\n            this._conversationsManager = initConversationsFn(this._remoteConfig, this._instance)\n            logger.info('Conversations loaded successfully')\n        } catch (e) {\n            this._handleLoadError('Error completing conversations initialization', e)\n        }\n    }\n\n    /** Helper to handle initialization errors */\n    private _handleLoadError(message: string, error?: any): void {\n        logger.error(message, error)\n        this._conversationsManager = null\n        this._isInitializing = false\n    }\n\n    /**\n     * Show the conversations widget (button and chat panel)\n     */\n    enable(): void {\n        if (!this._conversationsManager) {\n            logger.warn('Conversations not loaded yet.')\n            return\n        }\n        this._conversationsManager.enable()\n    }\n\n    /**\n     * Hide the conversations widget completely (button and chat panel)\n     */\n    disable(): void {\n        if (!this._conversationsManager) {\n            return\n        }\n        this._conversationsManager.disable()\n    }\n\n    /**\n     * Check if conversations are currently loaded and available\n     */\n    isLoaded(): boolean {\n        return !isNull(this._conversationsManager)\n    }\n\n    /**\n     * Check if conversations are enabled (based on remote config)\n     */\n    isEnabled(): boolean {\n        return this._isConversationsEnabled === true\n    }\n}\n"]}