{"version":3,"file":"product-tours-utils.js","sourceRoot":"","sources":["../../../../src/extensions/product-tours/product-tours-utils.ts"],"names":[],"mappings":"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","sourcesContent":["import {\n    ProductTourAppearance,\n    ProductTourSelectorError,\n    DEFAULT_PRODUCT_TOUR_APPEARANCE,\n} from '../../posthog-product-tours-types'\nimport { prepareStylesheet } from '../utils/stylesheet-loader'\nimport { document as _document, window as _window } from '../../utils/globals'\nimport { getFontFamily, getContrastingTextColor, hexToRgba } from '../surveys/surveys-extension-utils'\n\nimport productTourStyles from './product-tour.css'\n\nconst document = _document as Document\nconst window = _window as Window & typeof globalThis\n\nexport function getProductTourStylesheet(): HTMLStyleElement | null {\n    const stylesheet = prepareStylesheet(document, typeof productTourStyles === 'string' ? productTourStyles : '')\n    stylesheet?.setAttribute('data-ph-product-tour-style', 'true')\n    return stylesheet\n}\n\nexport interface ElementFindResult {\n    element: HTMLElement | null\n    error: ProductTourSelectorError | null\n    matchCount: number\n}\n\nexport function findElementBySelector(selector: string): ElementFindResult {\n    try {\n        const elements = document.querySelectorAll(selector)\n\n        if (elements.length === 0) {\n            return { element: null, error: 'not_found', matchCount: 0 }\n        }\n\n        const element = elements[0] as HTMLElement\n\n        if (!isElementVisible(element)) {\n            return { element: null, error: 'not_visible', matchCount: elements.length }\n        }\n\n        if (elements.length > 1) {\n            return { element, error: 'multiple_matches', matchCount: elements.length }\n        }\n\n        return { element, error: null, matchCount: 1 }\n    } catch {\n        return { element: null, error: 'not_found', matchCount: 0 }\n    }\n}\n\nexport function isElementVisible(element: HTMLElement): boolean {\n    const style = window.getComputedStyle(element)\n\n    if (style.display === 'none' || style.visibility === 'hidden' || style.opacity === '0') {\n        return false\n    }\n\n    const rect = element.getBoundingClientRect()\n    if (rect.width === 0 || rect.height === 0) {\n        return false\n    }\n\n    return true\n}\n\nexport function getElementMetadata(element: HTMLElement): {\n    tag: string\n    id: string | undefined\n    classes: string | undefined\n    text: string | undefined\n} {\n    return {\n        tag: element.tagName,\n        id: element.id || undefined,\n        classes: element.className || undefined,\n        text: element.innerText?.slice(0, 100) || undefined,\n    }\n}\n\nexport type TooltipPosition = 'top' | 'bottom' | 'left' | 'right'\n\nexport interface PositionResult {\n    top: number\n    left: number\n    position: TooltipPosition\n}\n\nconst TOOLTIP_MARGIN = 12\nconst TOOLTIP_WIDTH = 320\nconst TOOLTIP_HEIGHT_ESTIMATE = 180\n\nexport function calculateTooltipPosition(targetRect: DOMRect): PositionResult {\n    const viewportWidth = window.innerWidth\n    const viewportHeight = window.innerHeight\n\n    const spaceBelow = viewportHeight - targetRect.bottom\n    const spaceLeft = targetRect.left\n    const spaceRight = viewportWidth - targetRect.right\n\n    let position: TooltipPosition\n    let top: number\n    let left: number\n\n    if (spaceRight >= TOOLTIP_WIDTH + TOOLTIP_MARGIN) {\n        position = 'right'\n        top = targetRect.top + targetRect.height / 2 - TOOLTIP_HEIGHT_ESTIMATE / 2\n        left = targetRect.right + TOOLTIP_MARGIN\n    } else if (spaceLeft >= TOOLTIP_WIDTH + TOOLTIP_MARGIN) {\n        position = 'left'\n        top = targetRect.top + targetRect.height / 2 - TOOLTIP_HEIGHT_ESTIMATE / 2\n        left = targetRect.left - TOOLTIP_WIDTH - TOOLTIP_MARGIN\n    } else if (spaceBelow >= TOOLTIP_HEIGHT_ESTIMATE + TOOLTIP_MARGIN) {\n        position = 'bottom'\n        top = targetRect.bottom + TOOLTIP_MARGIN\n        left = targetRect.left + targetRect.width / 2 - TOOLTIP_WIDTH / 2\n    } else {\n        position = 'top'\n        top = targetRect.top - TOOLTIP_HEIGHT_ESTIMATE - TOOLTIP_MARGIN\n        left = targetRect.left + targetRect.width / 2 - TOOLTIP_WIDTH / 2\n    }\n\n    return { top, left, position }\n}\n\nexport function getSpotlightStyle(targetRect: DOMRect, padding: number = 8): Record<string, string> {\n    return {\n        top: `${targetRect.top - padding}px`,\n        left: `${targetRect.left - padding}px`,\n        width: `${targetRect.width + padding * 2}px`,\n        height: `${targetRect.height + padding * 2}px`,\n    }\n}\n\nexport function addProductTourCSSVariablesToElement(element: HTMLElement, appearance?: ProductTourAppearance): void {\n    const merged = { ...DEFAULT_PRODUCT_TOUR_APPEARANCE, ...appearance }\n    const style = element.style\n\n    // User-customizable variables\n    style.setProperty('--ph-tour-background-color', merged.backgroundColor)\n    style.setProperty('--ph-tour-text-color', merged.textColor)\n    style.setProperty('--ph-tour-button-color', merged.buttonColor)\n    style.setProperty('--ph-tour-border-radius', `${merged.borderRadius}px`)\n    style.setProperty('--ph-tour-button-border-radius', `${merged.buttonBorderRadius}px`)\n    style.setProperty('--ph-tour-border-color', merged.borderColor)\n    style.setProperty('--ph-tour-font-family', getFontFamily(merged.fontFamily))\n\n    // Derived colors\n    style.setProperty('--ph-tour-text-secondary-color', hexToRgba(merged.textColor, 0.6))\n    style.setProperty('--ph-tour-branding-text-color', getContrastingTextColor(merged.backgroundColor))\n    style.setProperty('--ph-tour-button-text-color', getContrastingTextColor(merged.buttonColor))\n    style.setProperty('--ph-tour-box-shadow', merged.boxShadow)\n    style.setProperty('--ph-tour-overlay-color', merged.showOverlay ? 'rgba(0, 0, 0, 0.5)' : 'transparent')\n\n    // Internal styling variables (not customizable)\n    style.setProperty('--ph-tour-button-secondary-color', 'transparent')\n    style.setProperty('--ph-tour-button-secondary-text-color', merged.textColor)\n    style.setProperty('--ph-tour-max-width', '320px')\n    style.setProperty('--ph-tour-padding', '16px')\n}\n\nexport function renderTipTapContent(content: any): string {\n    if (!content) {\n        return ''\n    }\n\n    if (typeof content === 'string') {\n        return escapeHtml(content)\n    }\n\n    if (content.type === 'text') {\n        let text = escapeHtml(content.text || '')\n\n        if (content.marks) {\n            for (const mark of content.marks) {\n                switch (mark.type) {\n                    case 'bold':\n                        text = `<strong>${text}</strong>`\n                        break\n                    case 'italic':\n                        text = `<em>${text}</em>`\n                        break\n                    case 'underline':\n                        text = `<u>${text}</u>`\n                        break\n                    case 'strike':\n                        text = `<s>${text}</s>`\n                        break\n                }\n            }\n        }\n\n        return text\n    }\n\n    const children = content.content?.map(renderTipTapContent).join('') || ''\n\n    switch (content.type) {\n        case 'doc':\n            return children\n        case 'paragraph':\n            return `<p>${children}</p>`\n        case 'heading': {\n            const level = content.attrs?.level || 1\n            return `<h${level}>${children}</h${level}>`\n        }\n        case 'bulletList':\n            return `<ul>${children}</ul>`\n        case 'orderedList':\n            return `<ol>${children}</ol>`\n        case 'listItem':\n            return `<li>${children}</li>`\n        case 'hardBreak':\n            return '<br>'\n        default:\n            return children\n    }\n}\n\nexport function normalizeUrl(url: string): string {\n    return url.endsWith('/') ? url.slice(0, -1) : url\n}\n\nfunction escapeHtml(text: string): string {\n    const div = document.createElement('div')\n    div.textContent = text\n    return div.innerHTML\n}\n"]}